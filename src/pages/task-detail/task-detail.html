<mcm-header></mcm-header>
<ion-content no-bounce class="has-header padding bottom" [ngClass]="keyboardVisible() ? 'mcm-keyboard-open' : ''">
    <div class="task-header" [ngClass]="{'gps' : task && task.solutionType=='gps'}">
        <div *ngIf="task && task.solutionType=='gps'" id="gpsTaskMap">
            <ion-fab bottom right *ngIf="task && task.solutionType=='gps'">
                <button ion-fab *ngFor="let item of gpsTaskButtonLabels; let i = index" ion-fab [color]="setFabColor(i)" (click)="taskDetailMap.setMarker(i)">
                    <span>{{item}}</span>
                </button>
            </ion-fab>
        </div>
        <img class="image" *ngIf="task && task.solutionType!='gps' && task.image" [src]="task.getImageURL()" (click)="openInPhotoviewer()" />
        <img class="image" *ngIf="task && !task.image && rootTask && rootTask.image && task.solutionType !='gps'" [src]="rootTask.getImageURL()" (click)="openInPhotoviewer(true)" />
    </div>
    <div class="task-content">
        <div class="transition"></div>
        <div class="card task has-button-on-the-edge">

            <div class="head">
                <ion-label>{{ "a_title_activity_task_view" | translate }}</ion-label>
                <ion-label class="tag score" *ngIf="!rootTask && !gamificationIsDisabled">{{possibleScore()}}</ion-label>
            </div>
            <p *ngIf="task">{{task.description}}</p>
            <div class="answer">
                <ion-label *ngIf ="task && task.solutionType != 'gps' && route.isAnswerValidationEnabled()">{{ "a_task_answer" | translate }}</ion-label>
                <ion-item *ngIf="task && taskDetails && task.solutionType != 'multiple_choice' && task.solutionType != 'gps' && route.isAnswerValidationEnabled()">
                    <!-- pattern="-?(0(([.,])[0-9]+)?|[1-9]{1}[0-9]*(([.,])[0-9]+)?)" -->
                    <ion-input (keyup.enter)="checkResult()"
                               [disabled]="taskDetails && (taskDetails.solved || taskDetails.solvedLow || taskDetails.failed)"
                               *ngIf="task.solutionType != 'text'"
                               type="text"
                               (focus)="setKeyboardOn(true)"
                               [ngModelOptions]="{standalone: true}"
                               readonly="true"
                               [(ngModel)]="taskDetails.answer"
                    >
                    </ion-input>
                    <ion-input [disabled]="taskDetails && (taskDetails.solved || taskDetails.solvedLow || taskDetails.failed)" *ngIf="task.solutionType == 'text'" type="text" [(ngModel)]="taskDetails.answer"></ion-input>
                </ion-item>
                <ion-list *ngIf="task && task.solutionType == 'multiple_choice' && multipleChoiceList && route.isAnswerValidationEnabled()">
                    <ion-item *ngFor="let item of multipleChoiceList; let i = index">
                        <ion-checkbox [disabled]="taskDetails && (taskDetails.solved || taskDetails.solvedLow || taskDetails.failed)" [(ngModel)]="item.userChecked"></ion-checkbox>
                        <ion-label tappable>{{item.value}}</ion-label>
                    </ion-item>
                </ion-list>
            </div>

            <div class="on-the-edge-container" *ngIf="taskDetails">
                <ion-grid no-padding>
                    <ion-row>
                        <ion-col *ngIf="route.isHintsEnabled()">
                            <button ion-button icon-only round color="primary" class="hint" [disabled]="false" *ngIf="task && task.hasHintMessage(1)" (click)="showHint(1)">
                                <img *ngIf="!taskDetails.hint1" class="round" src="./assets/icons/icon_hint-activated.svg"/>
                                <img *ngIf="taskDetails.hint1" class="round used" src="./assets/icons/icon_hint-activated-used.svg"/>
                            </button>
                            <button ion-button icon-only round color="primary" class="hint" [disabled]="!taskDetails.hint1" *ngIf="task && task.hasHintMessage(2)" (click)="showHint(2)">
                                <img *ngIf="taskDetails.hint1 && !taskDetails.hint2" class="round" src="./assets/icons/icon_hint-activated.svg"/>
                                <img *ngIf="taskDetails.hint1 && taskDetails.hint2" class="round used" src="./assets/icons/icon_hint-activated-used.svg"/>
                                <img *ngIf="!taskDetails.hint1" class="round" src="./assets/icons/icon_hint-deactivated.svg"/>
                            </button>
                            <button ion-button icon-only round color="primary" class="hint" [disabled]="!taskDetails.hint2" *ngIf="task && task.hasHintMessage(3)" (click)="showHint(3)">
                                <img *ngIf="taskDetails.hint1 && taskDetails.hint2 && !taskDetails.hint3" class="round" src="./assets/icons/icon_hint-activated.svg"/>
                                <img *ngIf="taskDetails.hint1 && taskDetails.hint2 && taskDetails.hint3" class="round used" src="./assets/icons/icon_hint-activated-used.svg"/>
                                <img *ngIf="!taskDetails.hint2" class="round" src="./assets/icons/icon_hint-deactivated.svg"/>
                            </button>
                        </ion-col>

                        <ion-col *ngIf="route.isAnswerValidationEnabled()">
                            <button ion-button small round *ngIf="task && taskDetails && (!taskDetails.solved && !taskDetails.solvedLow && !taskDetails.failed)"
                            [disabled]="!isDecimal(taskDetails.answer) && (task.solutionType == 'range' || task.solutionType == 'value')  || task.solutionType != 'multiple_choice' && !taskDetails.answer && (task.solutionType != 'gps' || !taskDetailMap?.areAllPointsSet())" (click)="checkResult()">
                                {{ "a_btn_check_answer" | translate }}
                            </button>
                        </ion-col>

                        <ion-col *ngIf="!route.isAnswerValidationEnabled()">
                            <button ion-button small round *ngIf="task && taskDetails && (!taskDetails.solved && !taskDetails.solvedLow && !taskDetails.failed)"
                                    (click)="completeTask()">
                                {{ "a_task_complete" | translate }}
                            </button>
                        </ion-col>

                        <ion-col>
                            <button class="hint" ion-button icon-only round color="primary" (click)="showSolutionSample()"
                            *ngIf="taskDetails && (taskDetails.solved || taskDetails.solvedLow || taskDetails.failed) && route.isSampleSolutionEnabled()">
                                <img class="round" src="./assets/icons/icon_show_sample_salution.svg"/>
                            </button>
                            <!-- open subtask -->
                            <button class="hint" ion-button icon-only round color="danger" (click)="openSubtask()"
                                    *ngIf="task.subtasks && task.subtasks.length !== solvedSubtasks.length && task && taskDetails && (!taskDetails.solved && !taskDetails.solvedLow && !taskDetails.failed)">
                                <img class="round" src="./assets/icons/subtask_icon.svg"/>
                            </button>
                            <!-- close subtask -->
                            <button class="hint" ion-button icon-only round color="danger" (click)="closeDetails()"
                                    *ngIf="rootTask && task && taskDetails && (!taskDetails.solved && !taskDetails.solvedLow && !taskDetails.failed)">
                                <img class="round" src="./assets/icons/task_icon.svg"/>
                            </button>
                            <!-- skip task -->
                            <button class="hint" ion-button icon-only round color="danger" (click)="confirmSkippingTask()"
                            *ngIf="!rootTask && task && taskDetails && (!taskDetails.solved && !taskDetails.solvedLow && !taskDetails.failed)">
                                <img class="round" src="./assets/icons/icon_skip.svg"/>
                            </button>
                            <!-- show next task -->
                            <button class="hint" ion-button icon-only round color="danger" (click)="closeDetails(false)"
                            *ngIf="taskDetails && (taskDetails.solved || taskDetails.solvedLow || taskDetails.failed)">
                                <img class="round" src="./assets/icons/icon_skip.svg"/>
                            </button>
                        </ion-col>
                    </ion-row>
                </ion-grid>

            </div>
        </div>

       <!-- <pre>taskDetails {{ taskDetails | json }}</pre> -->
        <div class="card evaluation" *ngIf="taskDetails && (taskDetails.solved || taskDetails.solvedLow || taskDetails?.failed)"
        [ngClass]="{'perfect' : taskDetails?.solved, 'good': taskDetails?.solvedLow, 'failed' : taskDetails?.failed }">
            <div class="head">
                <div *ngIf="taskDetails?.solved || taskDetails?.solvedLow">
                    <div *ngIf="route.isNarrativeEnabled() && route.hasNarrativeString(&quot;a_alert_congrats&quot;); else elseBlock">
                        <ion-label text-wrap>{{ route.getNarrativeString("a_alert_congrats") }}</ion-label>
                    </div>
                    <ng-template #elseBlock>
                        <ion-label text-wrap>{{ "a_alert_congrats" | translate }}</ion-label>
                    </ng-template>
                </div>
                <div *ngIf="taskDetails?.failed">
                    <div *ngIf="route.isNarrativeEnabled() && route.hasNarrativeString(&quot;good_luck_next_time&quot;); else elseBlock">
                        <ion-label text-wrap>{{ route.getNarrativeString("good_luck_next_time") }}</ion-label>
                    </div>
                    <ng-template #elseBlock>
                        <ion-label text-wrap>{{ "good_luck_next_time" | translate }}</ion-label>
                    </ng-template>
                </div>
                <ion-label class="tag score" *ngIf="!gamificationIsDisabled && taskDetails && (taskDetails.score || taskDetails.score == 0)">+ {{taskDetails.score}}</ion-label>
            </div>
        </div>

        <div class="card subtasks" *ngIf="task && task.subtasks">
            <ion-label>{{ "subtasks" | translate }}</ion-label>
            <div *ngFor="let subtask of solvedSubtasks; let i = index" class="accordion" [ngClass]="{'open': activeAccordions.indexOf(subtask.taskId) != -1}">
                <div class="accordion_title" (click)="changeSubtaskAccordionState(subtask.taskId)">
                    <p class="task_name">#{{i}} {{task.subtasks[i].title}}</p>
                    <div class="rating_container">
                    <div class="rating" [ngClass]="{'perfect': subtask.solved, 'good': subtask.solvedLow, 'failed': subtask.failed}"></div>
                    </div>
                    <img class="accordion_arrow" src="./assets/icons/down.svg">
                </div>
                <div class="accordion_content">
                    <span class="description">{{task.subtasks[i].description}}</span>
                    <ion-label class="answer">your answer<span class="answer">{{subtask.answer}}</span></ion-label>

                </div>
            </div>
        </div>

        <div *ngIf="!rootTask" id="keyboard-anchor"></div>
        <div *ngIf="rootTask" id="snd-keyboard-anchor"></div>
	    <div *ngIf="taskDetails && task.hasSideFacts()" class="card secondary">
                <div *ngIf="route.isNarrativeEnabled() && route.hasNarrativeString(&quot;a_did_you_know&quot;); else elseBlock">
                    <ion-label text-wrap>{{ route.getNarrativeString("a_did_you_know") }}</ion-label>
                </div>
                <ng-template #elseBlock>
                    <ion-label text-wrap>{{ "a_did_you_know" | translate }}</ion-label>
                </ng-template>
		    <p *ngIf="task">
			    {{task.getSideFactsText()}}
		    </p>
	    </div>
        <div class="card secondary">
            <ion-label>{{ "author" | translate }}</ion-label>
            <p *ngIf="task">
                {{task.author}}<br> {{task.mail}}
            </p>
        </div>
    </div>

</ion-content>
