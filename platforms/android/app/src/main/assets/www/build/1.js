webpackJsonp([1],{927:function(e,t,n){"use strict";function i(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,3,"ion-label",[],null,null,null,null,null)),S["ɵdid"](16384,null,0,oe.a,[le.a,S.ElementRef,S.Renderer,[8,null],[8,null],[8,null],[8,null]],null,null),(e()(),S["ɵted"](null,["",""])),S["ɵpid"](131072,re.a,[ae.a,S.ChangeDetectorRef])],null,function(e,t){e(t,2,0,S["ɵunv"](t,2,0,S["ɵnov"](t,3).transform("a_private_session_countdown")))})}function s(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,3,"ion-label",[],null,null,null,null,null)),S["ɵdid"](16384,null,0,oe.a,[le.a,S.ElementRef,S.Renderer,[8,null],[8,null],[8,null],[8,null]],null,null),(e()(),S["ɵted"](null,["",""])),S["ɵpid"](131072,re.a,[ae.a,S.ChangeDetectorRef])],null,function(e,t){e(t,2,0,S["ɵunv"](t,2,0,S["ɵnov"](t,3).transform("a_private_session_timer")))})}function o(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,3,"ion-label",[],null,null,null,null,null)),S["ɵdid"](16384,null,0,oe.a,[le.a,S.ElementRef,S.Renderer,[8,null],[8,null],[8,null],[8,null]],null,null),(e()(),S["ɵted"](null,["",""])),S["ɵpid"](131072,re.a,[ae.a,S.ChangeDetectorRef])],null,function(e,t){e(t,2,0,S["ɵunv"](t,2,0,S["ɵnov"](t,3).transform("a_private_session_ends")))})}function l(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,29,"ion-row",[["class","session row"]],null,null,null,null,null)),S["ɵdid"](16384,null,0,ue.a,[],null,null),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵeld"](0,null,null,4,"ion-col",[["class","countdown col"],["col",""]],null,null,null,null,null)),S["ɵdid"](16384,null,0,ce.a,[],null,null),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵeld"](0,null,null,0,"img",[["class","icon countdown"],["src","./assets/icons/countdown.svg"]],null,null,null,null,null)),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵeld"](0,null,null,11,"ion-col",[["class","col"]],null,null,null,null,null)),S["ɵdid"](16384,null,0,ce.a,[],null,null),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵand"](16777216,null,null,1,null,i)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵand"](16777216,null,null,1,null,s)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵand"](16777216,null,null,1,null,o)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵeld"](0,null,null,6,"ion-col",[["class","col"]],null,null,null,null,null)),S["ɵdid"](16384,null,0,ce.a,[],null,null),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵeld"](0,null,null,2,"ion-label",[],null,null,null,null,null)),S["ɵdid"](16384,null,0,oe.a,[le.a,S.ElementRef,S.Renderer,[8,null],[8,null],[8,null],[8,null]],null,null),(e()(),S["ɵted"](null,[""," Min"])),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵted"](null,["\n                "]))],function(e,t){var n=t.component;e(t,13,0,n.countdownBeforeSession);e(t,16,0,0==n.countdownBeforeSession);e(t,19,0,n.showSessionEnds)},function(e,t){e(t,27,0,t.component.countdownOrTimerForSession)})}function r(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,2,"ion-label",[],null,null,null,null,null)),S["ɵdid"](16384,null,0,oe.a,[le.a,S.ElementRef,S.Renderer,[8,null],[8,null],[8,null],[8,null]],null,null),(e()(),S["ɵted"](null,["",""]))],null,function(e,t){e(t,2,0,t.component.user.name)})}function a(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,2,"ion-label",[],null,null,null,null,null)),S["ɵdid"](16384,null,0,oe.a,[le.a,S.ElementRef,S.Renderer,[8,null],[8,null],[8,null],[8,null]],null,null),(e()(),S["ɵted"](null,["",""]))],null,function(e,t){e(t,2,0,t.component.sessionInfo.sessionUser.team_name)})}function u(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,20,"ion-row",[["class","current row"]],null,null,null,null,null)),S["ɵdid"](16384,null,0,ue.a,[],null,null),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵeld"](0,null,null,8,"ion-col",[["class","col"]],null,null,null,null,null)),S["ɵdid"](16384,null,0,ce.a,[],null,null),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵand"](16777216,null,null,1,null,r)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵand"](16777216,null,null,1,null,a)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵeld"](0,null,null,6,"ion-col",[["class","col"]],null,null,null,null,null)),S["ɵdid"](16384,null,0,ce.a,[],null,null),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵeld"](0,null,null,2,"ion-label",[["class","score"]],null,null,null,null,null)),S["ɵdid"](16384,null,0,oe.a,[le.a,S.ElementRef,S.Renderer,[8,null],[8,null],[8,null],[8,null]],null,null),(e()(),S["ɵted"](null,["",""])),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵted"](null,["\n                "]))],function(e,t){var n=t.component;e(t,7,0,!n.sessionInfo);e(t,10,0,n.sessionInfo)},function(e,t){e(t,18,0,t.component.currentScore)})}function c(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,0,"img",[["class","icon arrow"],["src","./assets/icons/up.svg"]],null,null,null,null,null))],null,null)}function d(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,0,"img",[["class","icon arrow"],["src","./assets/icons/down.svg"]],null,null,null,null,null))],null,null)}function h(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,30,"ion-row",[["class","row"]],null,null,null,null,null)),S["ɵdid"](278528,null,0,de.i,[S.IterableDiffers,S.KeyValueDiffers,S.ElementRef,S.Renderer],{ngClass:[0,"ngClass"]},null),S["ɵpod"]({self:0}),S["ɵdid"](16384,null,0,ue.a,[],null,null),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵeld"](0,null,null,8,"ion-col",[["class","chart col"]],null,null,null,null,null)),S["ɵdid"](16384,null,0,ce.a,[],null,null),(e()(),S["ɵted"](null,["\n                            "])),(e()(),S["ɵand"](16777216,null,null,1,null,c)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n                            "])),(e()(),S["ɵand"](16777216,null,null,1,null,d)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵted"](null,["\n\n                        "])),(e()(),S["ɵeld"](0,null,null,6,"ion-col",[["class","col"]],null,null,null,null,null)),S["ɵdid"](16384,null,0,ce.a,[],null,null),(e()(),S["ɵted"](null,["\n                            "])),(e()(),S["ɵeld"](0,null,null,2,"ion-label",[],null,null,null,null,null)),S["ɵdid"](16384,null,0,oe.a,[le.a,S.ElementRef,S.Renderer,[8,null],[8,null],[8,null],[8,null]],null,null),(e()(),S["ɵted"](null,["",""])),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵeld"](0,null,null,6,"ion-col",[["class","col"]],null,null,null,null,null)),S["ɵdid"](16384,null,0,ce.a,[],null,null),(e()(),S["ɵted"](null,["\n                            "])),(e()(),S["ɵeld"](0,null,null,2,"ion-label",[["class","score"]],null,null,null,null,null)),S["ɵdid"](16384,null,0,oe.a,[le.a,S.ElementRef,S.Renderer,[8,null],[8,null],[8,null],[8,null]],null,null),(e()(),S["ɵted"](null,["",""])),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵted"](null,["\n                    "]))],function(e,t){var n=t.component;e(t,1,0,e(t,2,0,t.context.$implicit.self));e(t,9,0,n.chatAndSessionService.getLeaderboard().length>1&&0==t.context.index&&!t.context.$implicit.self);e(t,12,0,n.chatAndSessionService.getLeaderboard().length>1&&0!=t.context.index&&!t.context.$implicit.self)},function(e,t){e(t,20,0,t.context.$implicit.team_name);e(t,28,0,t.context.$implicit.score)})}function p(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,4,"div",[],null,null,null,null,null)),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵand"](16777216,null,null,1,null,h)),S["ɵdid"](802816,null,0,de.j,[S.ViewContainerRef,S.TemplateRef,S.IterableDiffers],{ngForOf:[0,"ngForOf"]},null),(e()(),S["ɵted"](null,["\n                "]))],function(e,t){e(t,3,0,t.component.chatAndSessionService.getLeaderboard())},null)}function f(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,14,"div",[["class","detail-box"],["id","ranking"]],null,null,null,null,null)),(e()(),S["ɵted"](null,["\n            "])),(e()(),S["ɵeld"](0,null,null,11,"ion-grid",[["class","table grid"]],null,null,null,null,null)),S["ɵdid"](16384,null,0,he.a,[],null,null),(e()(),S["ɵted"](null,["\n                "])),(e()(),S["ɵand"](16777216,null,null,1,null,l)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n                "])),(e()(),S["ɵand"](16777216,null,null,1,null,u)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n                "])),(e()(),S["ɵand"](16777216,null,null,1,null,p)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n            "])),(e()(),S["ɵted"](null,["\n        "]))],function(e,t){var n=t.component;e(t,6,0,null!=n.sessionInfo&&n.showCountdownOrTimer);e(t,9,0,n.route.isAnswerFeedbackEnabled()&&!n.gamificationIsDisabled&&n.currentScore&&n.currentScore>0&&(null==n.sessionInfo||!n.sessionInfo.session.has_leaderboard));e(t,12,0,null!=n.sessionInfo&&n.sessionInfo.session.has_leaderboard&&n.route.isAnswerFeedbackEnabled())},null)}function _(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,5,"button",[["color","danger"],["ion-fab",""]],[[8,"hidden",0]],[[null,"click"]],function(e,t,n){var i=!0;if("click"===t){i=!1!==e.component.displayResetTasksModal()&&i}return i},pe.b,pe.a)),S["ɵdid"](49152,[[4,4],[2,4]],0,fe.a,[le.a,S.ElementRef,S.Renderer],{color:[0,"color"]},null),(e()(),S["ɵted"](0,["\n                        "])),(e()(),S["ɵeld"](0,null,0,1,"ion-icon",[["name","icon-restart"],["role","img"]],[[2,"hide",null]],null,null,null,null)),S["ɵdid"](147456,null,0,_e.a,[le.a,S.ElementRef,S.Renderer],{name:[0,"name"]},null),(e()(),S["ɵted"](0,["\n                    "]))],function(e,t){e(t,1,0,"danger");e(t,4,0,"icon-restart")},function(e,t){e(t,0,0,null!=t.component.sessionInfo);e(t,3,0,S["ɵnov"](t,4)._hidden)})}function m(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,5,"button",[["color","danger"],["ion-fab",""]],null,[[null,"click"]],function(e,t,n){var i=!0;if("click"===t){i=!1!==e.component.sessionFinished()&&i}return i},pe.b,pe.a)),S["ɵdid"](49152,[[4,4],[2,4]],0,fe.a,[le.a,S.ElementRef,S.Renderer],{color:[0,"color"]},null),(e()(),S["ɵted"](0,["\n                        "])),(e()(),S["ɵeld"](0,null,0,1,"ion-icon",[["name","icon-exit"],["role","img"]],[[2,"hide",null]],null,null,null,null)),S["ɵdid"](147456,null,0,_e.a,[le.a,S.ElementRef,S.Renderer],{name:[0,"name"]},null),(e()(),S["ɵted"](0,["\n                    "]))],function(e,t){e(t,1,0,"danger");e(t,4,0,"icon-exit")},function(e,t){e(t,3,0,S["ɵnov"](t,4)._hidden)})}function g(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,5,"button",[["color","primary"],["ion-fab",""]],null,[[null,"click"]],function(e,t,n){var i=!0;if("click"===t){i=!1!==e.component.navigateToChat()&&i}return i},pe.b,pe.a)),S["ɵdid"](49152,[[4,4],[2,4]],0,fe.a,[le.a,S.ElementRef,S.Renderer],{color:[0,"color"]},null),(e()(),S["ɵted"](0,["\n                        "])),(e()(),S["ɵeld"](0,null,0,1,"ion-icon",[["name","icon-chat"],["role","img"]],[[2,"hide",null]],null,null,null,null)),S["ɵdid"](147456,null,0,_e.a,[le.a,S.ElementRef,S.Renderer],{name:[0,"name"]},null),(e()(),S["ɵted"](0,["\n                    "]))],function(e,t){e(t,1,0,"primary");e(t,4,0,"icon-chat")},function(e,t){e(t,3,0,S["ɵnov"](t,4)._hidden)})}function v(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,3,"span",[["class","badge-top-right"]],null,null,null,null,null)),S["ɵdid"](278528,null,0,de.i,[S.IterableDiffers,S.KeyValueDiffers,S.ElementRef,S.Renderer],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),S["ɵpod"]({"badge-no-show":0}),(e()(),S["ɵted"](null,["",""]))],function(e,t){e(t,1,0,"badge-top-right",e(t,2,0,0==t.component.chatAndSessionService.getNewMsgNumber()))},function(e,t){e(t,3,0,t.component.chatAndSessionService.getNewMsgNumber())})}function k(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,3,"span",[["class","badge-top-right"]],null,null,null,null,null)),S["ɵdid"](278528,null,0,de.i,[S.IterableDiffers,S.KeyValueDiffers,S.ElementRef,S.Renderer],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),S["ɵpod"]({"badge-no-show":0}),(e()(),S["ɵted"](null,["",""]))],function(e,t){e(t,1,0,"badge-top-right",e(t,2,0,0==t.component.chatAndSessionService.getNewMsgNumber()))},function(e,t){e(t,3,0,t.component.chatAndSessionService.getNewMsgNumber())})}function y(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,6,"div",[["class","image-container"],["tappable",""]],null,[[null,"click"]],function(e,t,n){var i=!0,s=e.component;if("click"===t){i=!1!==s.gototask(s.state.selectedTask.id,s.state.selectedTask.title)&&i}return i},null,null)),(e()(),S["ɵted"](null,["\n                "])),(e()(),S["ɵeld"](0,null,null,3,"div",[["class","cover"]],null,null,null,null,null)),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵeld"](0,null,null,0,"img",[["class","thumb"]],[[8,"src",4]],null,null,null,null)),(e()(),S["ɵted"](null,["\n                "])),(e()(),S["ɵted"](null,["\n            "]))],null,function(e,t){e(t,4,0,t.component.state.selectedTask.getImageURL())})}function L(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,29,"div",[["class","text-container"]],null,null,null,null,null)),(e()(),S["ɵted"](null,["\n                "])),(e()(),S["ɵeld"](0,null,null,10,"div",[["class","segmented-box"]],null,null,null,null,null)),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵeld"](0,null,null,7,"div",[["class","title segement"]],null,null,null,null,null)),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵeld"](0,null,null,1,"span",[["tappable",""]],null,[[null,"click"]],function(e,t,n){var i=!0,s=e.component;if("click"===t){i=!1!==s.gototask(s.state.selectedTask.id,s.state.selectedTask.title)&&i}return i},null,null)),(e()(),S["ɵted"](null,["#",""])),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵeld"](0,null,null,1,"h2",[["tappable",""]],null,[[null,"click"]],function(e,t,n){var i=!0,s=e.component;if("click"===t){i=!1!==s.gototask(s.state.selectedTask.id,s.state.selectedTask.title)&&i}return i},null,null)),(e()(),S["ɵted"](null,["",""])),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵted"](null,["\n                "])),(e()(),S["ɵted"](null,["\n                "])),(e()(),S["ɵeld"](0,null,null,14,"div",[["class","segmented-box bottom"]],null,null,null,null,null)),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵeld"](0,null,null,9,"div",[["class","segement buttons"]],null,null,null,null,null)),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵeld"](0,null,null,6,"div",[["class","text-right"]],null,null,null,null,null)),(e()(),S["ɵted"](null,["\n                            "])),(e()(),S["ɵeld"](0,null,null,3,"button",[["ion-button",""],["round",""],["small",""]],null,[[null,"click"]],function(e,t,n){var i=!0,s=e.component;if("click"===t){i=!1!==s.gototask(s.state.selectedTask.id,s.state.selectedTask.title)&&i}return i},me.b,me.a)),S["ɵdid"](1097728,null,0,ge.a,[[8,""],le.a,S.ElementRef,S.Renderer],{small:[0,"small"],round:[1,"round"]},null),(e()(),S["ɵted"](0,["",""])),S["ɵpid"](131072,re.a,[ae.a,S.ChangeDetectorRef]),(e()(),S["ɵted"](null,["\n                        "])),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵted"](null,["\n                "])),(e()(),S["ɵted"](null,["\n            "]))],function(e,t){e(t,23,0,"","")},function(e,t){var n=t.component;e(t,7,0,n.state.selectedTask.position);e(t,10,0,n.state.selectedTask.title);e(t,24,0,S["ɵunv"](t,24,0,S["ɵnov"](t,25).transform("a_alert_show_task")))})}function b(e){return S["ɵvid"](0,[S["ɵqud"](402653184,1,{mapContainer:0}),(e()(),S["ɵeld"](0,null,null,1,"mcm-header",[],null,null,null,ve.b,ve.a)),S["ɵdid"](114688,null,0,ke.a,[ye.a,Le.a,be.a,O.a,z.a,R.a],null,null),(e()(),S["ɵted"](null,["\n"])),(e()(),S["ɵeld"](0,null,null,66,"ion-content",[["class","has-header map tasks"]],[[2,"statusbar-padding",null],[2,"has-refresher",null]],null,null,Se.b,Se.a)),S["ɵdid"](4374528,null,0,Ce.a,[le.a,Te.a,we.a,S.ElementRef,S.Renderer,Me.a,Ie.a,S.NgZone,[2,be.a],[2,ye.a]],null,null),(e()(),S["ɵted"](1,["\n    "])),(e()(),S["ɵeld"](0,null,0,62,"div",[["ion-fixed",""]],null,null,null,null,null)),(e()(),S["ɵted"](null,["\n        "])),(e()(),S["ɵeld"](0,null,null,0,"div",[["class","map-view"],["id","tasks-map"]],null,null,null,null,null)),(e()(),S["ɵted"](null,["\n\n        "])),(e()(),S["ɵand"](16777216,null,null,1,null,f)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n\n        "])),(e()(),S["ɵeld"](0,null,null,54,"div",[["class","detail-box"],["id","details"]],null,null,null,null,null)),S["ɵdid"](278528,null,0,de.i,[S.IterableDiffers,S.KeyValueDiffers,S.ElementRef,S.Renderer],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),S["ɵpod"]({open:0}),(e()(),S["ɵted"](null,["\n\n            "])),(e()(),S["ɵeld"](0,null,null,43,"ion-fab",[["right",""],["top",""]],null,null,null,xe.b,xe.a)),S["ɵdid"](1228800,null,2,Re.a,[Te.a],null,null),S["ɵqud"](603979776,2,{_mainButton:0}),S["ɵqud"](603979776,3,{_fabLists:1}),(e()(),S["ɵted"](0,["\n                "])),(e()(),S["ɵeld"](0,null,0,3,"button",[["color","primary"],["ion-fab",""]],null,[[null,"click"]],function(e,t,n){var i=!0,s=e.component;if("click"===t){i=!1!=(s.fabListOpen=!s.fabListOpen)&&i}return i},pe.b,pe.a)),S["ɵdid"](49152,[[2,4]],0,fe.a,[le.a,S.ElementRef,S.Renderer],{color:[0,"color"]},null),(e()(),S["ɵeld"](0,null,0,1,"ion-icon",[["name","more"],["role","img"]],[[2,"hide",null]],null,null,null,null)),S["ɵdid"](147456,null,0,_e.a,[le.a,S.ElementRef,S.Renderer],{name:[0,"name"]},null),(e()(),S["ɵted"](0,["\n                "])),(e()(),S["ɵeld"](0,null,0,29,"ion-fab-list",[["side","top"]],null,null,null,null,null)),S["ɵdid"](16384,[[3,4]],1,Ae.a,[S.ElementRef,S.Renderer,le.a,Te.a],null,null),S["ɵqud"](603979776,4,{_setbuttons:1}),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵand"](16777216,null,null,1,null,_)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵeld"](0,null,null,5,"button",[["color","primary"],["ion-fab",""]],[[8,"hidden",0]],[[null,"click"]],function(e,t,n){var i=!0;if("click"===t){i=!1!==e.component.selectStartPoint()&&i}return i},pe.b,pe.a)),S["ɵdid"](49152,[[4,4],[2,4]],0,fe.a,[le.a,S.ElementRef,S.Renderer],{color:[0,"color"]},null),(e()(),S["ɵted"](0,["\n                        "])),(e()(),S["ɵeld"](0,null,0,1,"ion-icon",[["name","icon-starting-point"],["role","img"]],[[2,"hide",null]],null,null,null,null)),S["ɵdid"](147456,null,0,_e.a,[le.a,S.ElementRef,S.Renderer],{name:[0,"name"]},null),(e()(),S["ɵted"](0,["\n                    "])),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵeld"](0,null,null,5,"button",[["color","danger"],["ion-fab",""]],[[8,"hidden",0]],[[null,"click"]],function(e,t,n){var i=!0;if("click"===t){i=!1!==e.component.showAllTasks()&&i}return i},pe.b,pe.a)),S["ɵdid"](49152,[[4,4],[2,4]],0,fe.a,[le.a,S.ElementRef,S.Renderer],{color:[0,"color"]},null),(e()(),S["ɵted"](0,["\n                        "])),(e()(),S["ɵeld"](0,null,0,1,"ion-icon",[["name","icon-visibility"],["role","img"]],[[2,"hide",null]],null,null,null,null)),S["ɵdid"](147456,null,0,_e.a,[le.a,S.ElementRef,S.Renderer],{name:[0,"name"]},null),(e()(),S["ɵted"](0,["\n                    "])),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵand"](16777216,null,null,1,null,m)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵand"](16777216,null,null,1,null,g)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n                    "])),(e()(),S["ɵand"](16777216,null,null,1,null,v)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n                "])),(e()(),S["ɵted"](0,["\n                "])),(e()(),S["ɵand"](16777216,null,0,1,null,k)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](0,["\n            "])),(e()(),S["ɵted"](null,["\n\n            "])),(e()(),S["ɵand"](16777216,null,null,1,null,y)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n            "])),(e()(),S["ɵand"](16777216,null,null,1,null,L)),S["ɵdid"](16384,null,0,de.k,[S.ViewContainerRef,S.TemplateRef],{ngIf:[0,"ngIf"]},null),(e()(),S["ɵted"](null,["\n        "])),(e()(),S["ɵted"](null,["\n    "])),(e()(),S["ɵted"](1,["\n"])),(e()(),S["ɵted"](null,["\n"]))],function(e,t){var n=t.component;e(t,2,0);e(t,12,0,!n.gamificationIsDisabled&&n.currentScore&&n.currentScore>0||null!=n.sessionInfo&&n.showCountdownOrTimer);e(t,15,0,"detail-box",e(t,16,0,n.state.selectedTask));e(t,24,0,"primary");e(t,26,0,"more");e(t,33,0,null==n.sessionInfo);e(t,36,0,"primary");e(t,39,0,"icon-starting-point");e(t,43,0,"danger");e(t,46,0,"icon-visibility");e(t,50,0,null!=n.sessionInfo);e(t,53,0,null!=n.sessionInfo);e(t,56,0,null!=n.sessionInfo&&n.fabListOpen);e(t,60,0,null!=n.sessionInfo&&!n.fabListOpen);e(t,64,0,n.state.selectedTask);e(t,67,0,n.state.selectedTask)},function(e,t){var n=t.component;e(t,4,0,S["ɵnov"](t,5).statusbarPadding,S["ɵnov"](t,5)._hasRefresher);e(t,25,0,S["ɵnov"](t,26)._hidden);e(t,35,0,!n.state.isShowingAllTasks||n.assignedTask());e(t,38,0,S["ɵnov"](t,39)._hidden);e(t,42,0,n.state.isShowingAllTasks||n.assignedTask());e(t,45,0,S["ɵnov"](t,46)._hidden)})}Object.defineProperty(t,"__esModule",{value:!0});var S=n(1),C=(n(0),n(17),n(43)),T=n(138),w=(n(935),n(938),n(28)),M=n(615),I=n(37),x=n(294),R=n(26),A=n(108),O=n(53),P=(n(941),n(944),n(41)),E=(n(64),n(55)),N=n(140),B=n(280),U=n(298),z=n(48),G=n(299),D=n(197),Z=n(60),F=n(3),V=n(296),j=n(300),H=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(s,o){function l(e){try{a(i.next(e))}catch(e){o(e)}}function r(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){e.done?s(e.value):new n(function(t){t(e.value)}).then(l,r)}a((i=i.apply(e,t||[])).next())})},W=this&&this.__generator||function(e,t){function n(n){return function(l){return function(n){if(i)throw new TypeError("Generator is already executing.");for(;r;)try{if(i=1,s&&(o=s[2&n[0]?"return":n[0]?"throw":"next"])&&!(o=o.call(s,n[1])).done)return o;switch(s=0,o&&(n=[0,o.value]),n[0]){case 0:case 1:o=n;break;case 4:return r.label++,{value:n[1],done:!1};case 5:r.label++,s=n[1],n=[0];continue;case 7:n=r.ops.pop(),r.trys.pop();continue;default:if(o=r.trys,!(o=o.length>0&&o[o.length-1])&&(6===n[0]||2===n[0])){r=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){r.label=n[1];break}if(6===n[0]&&r.label<o[1]){r.label=o[1],o=n;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(n);break}o[2]&&r.ops.pop(),r.trys.pop();continue}n=t.call(e,r)}catch(e){n=[6,e],s=0}finally{i=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,l])}}var i,s,o,l,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return l={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l},q=function(){function TasksMap(t,n,i,s,o,l,r,a,u,c,d,h,p,f){var _=this;this.navCtrl=t,this.navParams=n,this.events=i,this.ormService=s,this.deepLinker=o,this.gpsService=l,this.modalsService=r,this.imagesService=a,this.storage=u,this.spinner=c,this.modalCtrl=d,this.chatAndSessionService=h,this.app=p,this.helper=f,this.state={selectedTask:null,isShowingAllTasks:!1,visibleTasks:{},skippedTaskIds:[],selectedStartTask:!1,showIntroModal:!1,showGuidedTrailModal:!1},this.stateKey="savedMapStateByRoute",this.taskToSkip=null,this.gamificationIsDisabled=!1,this.isUserInsideMap=!0,this.user=null,this.countdownBeforeSession=!1,this.startInterval=!1,this.showCountdownOrTimer=!1,this.showSessionEnds=!1,this.taskBlocked=!1,this.sessionTimeTimer=V.Observable.interval(1e3*e.UPDATE_SESSION_TIME_INTERVAL_IN_SECS),this.markerGroup=null,this.chatAndSessionService.init(),this.events.subscribe("user:kicked",function(e){"self"==e?(console.log("userKicked"),_.sessionKicked(),_.events.unsubscribe("user:kicked",null)):console.log("Someone else was kicked.")}),this.events.subscribe("session:updated",function(e){console.log("Session has been updated"),_.updateSession(e)}),this.events.subscribe("user:assigned_task",function(e){console.log("User has been assigned task with id: "+e),_.sessionInfo.sessionUser.assigned_task_id=e,_.forceStartFromTask(e),_.redrawMarker()})}return e=TasksMap,TasksMap.prototype.isTrailCompleted=function(){return this.route.isAnswerFeedbackEnabled()?this.taskList&&this.score.getTasksSolved().length+this.score.getTasksSolvedLow().length+this.score.getTasksFailed().length==this.taskList.length:this.score.getTasksSaved()&&this.score.getTasksSaved().length==this.taskList.length},TasksMap.prototype.showTrailCompletedAlert=function(){var e=this,t=this.modalCtrl.create(j.a,{score:this.score,tasks:this.taskList,narrative:this.app.activeNarrative,callback:function(){t.dismiss().then(function(){e.route.completed=!0,e.route.completedDate=(new Date).toDateString().split(" ").slice(1).join(" "),e.ormService.saveAndFireChangedEvent(e.route)})}},{cssClass:this.app.activeNarrative});t.present()},TasksMap.prototype.ionViewWillEnter=function(){return H(this,void 0,void 0,function(){var e,t,n,i=this;return W(this,function(s){switch(s.label){case 0:return console.log("TasksMap ionViewWillEnter()"),console.log(this.navCtrl),this.routeId=this.navParams.get("routeId"),console.log(this.routeId),e=this,[4,this.ormService.findRouteById(this.routeId)];case 1:return e.route=s.sent(),this.gamificationIsDisabled=this.route.isGamificationDisabled(),t=this,[4,this.ormService.getActiveUser()];case 2:return t.user=s.sent(),this.score=this.route.getScoreForUser(this.user),n=this.chatAndSessionService.getSessionInfo(),this.updateSession(n),this.events.publish("narrativeChange",this.route.getNarrativeName()),this.updateIcons(),[4,this.loadMap()];case 3:return s.sent(),setTimeout(function(){return H(i,void 0,void 0,function(){return W(this,function(e){switch(e.label){case 0:return[4,this.initializeMap()];case 1:return e.sent(),this.spinner.hide(),this.isTrailCompleted()&&!this.route.completed&&this.showTrailCompletedAlert(),[2]}})})},100),[2]}})})},TasksMap.prototype.ionViewDidEnter=function(){return H(this,void 0,void 0,function(){var e,t,n,i=this;return W(this,function(s){switch(s.label){case 0:return console.log("TasksMap ionViewDidEnter()"),null==this.sessionInfo?[3,5]:(e=JSON.stringify({}),this.chatAndSessionService.addUserEvent("event_trail_opened",e,"0"),!1!==this.sessionInfo.started?[3,5]:(this.showAllTasks(),this.resetTasks(),0==this.sessionInfo.sessionUser.assigned_task_id?[3,2]:(t=this,[4,this.route.getTasks()])));case 1:return t.taskList=s.sent(),this.forceStartFromTask(this.sessionInfo.sessionUser.assigned_task_id),this.route.isNarrativeEnabled()&&this.showIntroModal().then(function(){i.state.showIntroModal=!1}),[3,3];case 2:this.route.isNarrativeEnabled()&&this.showIntroModal().then(function(){i.state.showIntroModal=!1,i.showGuidedTrailModalWithDelay(500)}),s.label=3;case 3:return this.saveMapStateToLocalStorage(),this.sessionInfo.started=!0,[4,this.chatAndSessionService.updateSession(this.sessionInfo)];case 4:return s.sent(),this.redrawMarker(),[2];case 5:return this.navParams.data.tasksMapState?(console.log("3"),this.state=this.navParams.data.tasksMapState,(this.taskToSkip||this.state.selectedStartTask&&(this.score.getTasksSolved().indexOf(this.state.selectedTask.id)>-1||this.score.getTasksSolvedLow().indexOf(this.state.selectedTask.id)>-1))&&this.goToNextTask(this.state.selectedTask,!0),[3,8]):[3,6];case 6:return n=this,[4,this.getMapStateFromLocalStorage()];case 7:n.state=s.sent(),console.log(this.state),this.taskToSkip&&(this.goToNextTask(this.taskToSkip,!0),this.taskToSkip=null),this.state?this.state.showIntroModal&&this.route.isNarrativeEnabled()?this.showIntroModal().then(function(){i.state.showIntroModal=!1,i.saveMapStateToLocalStorage(),i.state.showGuidedTrailModal&&i.showGuidedTrailModalWithDelay(500)}):this.state.showGuidedTrailModal&&this.showGuidedTrailModalWithDelay(500):(this.state=this.navParams.data.tasksMapState={selectedTask:this.navParams.get("selectedTask"),isShowingAllTasks:!1,visibleTasks:{},skippedTaskIds:[],selectedStartTask:!1,showIntroModal:!1,showGuidedTrailModal:!1},this.state.isShowingAllTasks=!this.state.selectedTask,this.state.selectedTask?this.state.visibleTasks[this.state.selectedTask.position]=!0:this.route.isNarrativeEnabled()?this.showIntroModal().then(function(){i.showGuidedTrailModalWithDelay(500)}):this.showGuidedTrailModalWithDelay(500)),s.label=8;case 8:return this.redrawMarker(),[2]}})})},TasksMap.prototype.showGuidedTrailModalWithDelay=function(e){var t=this;this.state.showGuidedTrailModal=!1,setTimeout(function(){var e=this;t.modalsService.showDialog("a_guided_trail_title","a_guided_trail","no",function(){},"yes",function(){return H(e,void 0,void 0,function(){return W(this,function(e){return t.selectStartPoint(),t.state.selectedStartTask=!0,[2]})})},t.app.activeNarrative)},e)},TasksMap.prototype.forceStartFromTask=function(e){var t=this.taskList.filter(function(t){return t.id==e}).pop();this.state.selectedTask=t,this.state.visibleTasks={},this.state.visibleTasks[t.position]=!0,this.state.isShowingAllTasks=!1,this.state.showGuidedTrailModal=!1,this.centerSelectedTask()},TasksMap.prototype.ngOnInit=function(){},TasksMap.prototype.ngOnDestroy=function(){this.sessionSubscription&&(this.sessionSubscription.unsubscribe(),this.sessionSubscription=null),this.watchSubscription&&(this.watchSubscription.unsubscribe(),this.watchSubscription=null),this.events.unsubscribe("user:kicked"),this.events.unsubscribe("session:updated"),this.events.unsubscribe("user:assigned_task"),this.events.publish("narrativeChange","default")},TasksMap.prototype.initializeMap=function(){return H(this,void 0,void 0,function(){return W(this,function(e){return this.currentScore=this.score.score,this.redrawMarker(),this.gpsService.isLocationOn(),null!=this.map&&this.map.invalidateSize(),[2]})})},TasksMap.prototype.updateSession=function(e){var t=this;console.log(this.routeId),console.log(e),e&&e.session?this.routeId!=e.session.trail_id?(console.log("active session belongs to different trail"),this.sessionInfo=null):(this.sessionInfo=e,console.log("active session: "+e.session.code),this.sessionTimeSubscription&&this.sessionTimeSubscription.unsubscribe(),this.sessionTime(),this.sessionTimeSubscription=this.sessionTimeTimer.subscribe(function(e){t.sessionTime()})):(console.log("no active session"),this.sessionInfo=null)},TasksMap.prototype.getMapStateFromLocalStorage=function(){return H(this,void 0,void 0,function(){var e,t;return W(this,function(n){switch(n.label){case 0:return[4,this.storage.get(this.stateKey)];case 1:return(e=n.sent())&&e[this.routeId]?(t=e[this.routeId],console.log(this.navParams),t.selectedTask=this.navParams.get("selectedTask"),[2,t]):[2,null]}})})},TasksMap.prototype.saveMapStateToLocalStorage=function(){return H(this,void 0,void 0,function(){var e;return W(this,function(t){switch(t.label){case 0:return[4,this.storage.get(this.stateKey)];case 1:return(e=t.sent())||(e={}),e[this.routeId]=this.state,[2,this.storage.set(this.stateKey,e)]}})})},TasksMap.prototype.ionViewWillLeave=function(){return H(this,void 0,void 0,function(){return W(this,function(e){return this.saveMapStateToLocalStorage(),[2]})})},TasksMap.prototype.assignedTask=function(){return null!=this.sessionInfo&&this.sessionInfo.session.assign_tasks},TasksMap.prototype.redrawMarker=function(){return H(this,void 0,void 0,function(){var e,t,n,i,s,o=this;return W(this,function(l){switch(l.label){case 0:return this.map?(null!=this.markerGroup&&(console.warn("removing markerGroup"),this.map.removeLayer(this.markerGroup),this.markerGroup=null),e=T.markerClusterGroup({maxClusterRadius:30,iconCreateFunction:function(e){var t=e.getChildCount(),n=e.getAllChildMarkers(),i="marker-cluster marker-cluster-";i+=t<10?"small":t<100?"medium":"large";var s={},o=0;n.map(function(e){e.options.icon.clusterColor&&(o++,s[e.options.icon.clusterColor]?s[e.options.icon.clusterColor]+=1:s[e.options.icon.clusterColor]=1)});var l="",r="",a=Object.keys(s);if(1==a.length)l="background-color: "+a[0];else{var u="",c=0;a.map(function(e){var t=s[e],n=Math.round(t/o*100);c>0&&(u+=", "),u+=e+" 0 "+(c+=n)+"%"});r='<img src="'+new ConicGradient({stops:u,size:24}).png+'"></img>'}return new T.DivIcon({html:'<div style="'+l+'">'+r+"<span>"+t+"</span></div>",className:i,iconSize:new T.Point(40,40)})}}),t=this,[4,this.route.getTasks()]):[2];case 1:for(t.taskList=l.sent(),n=function(t){var n=i.taskList[t];if(!i.state.isShowingAllTasks&&!i.state.visibleTasks[n.position])return"continue";var s=i.taskOpenIcon,l=!0;i.score.getTasksSaved().indexOf(n.id)>-1?s=i.taskSavedIcon:i.score.getTasksSolved().indexOf(n.id)>-1?s=i.taskDonePerfectIcon:i.score.getTasksSolvedLow().indexOf(n.id)>-1?s=i.taskDoneIcon:i.score.getTasksFailed().indexOf(n.id)>-1?s=i.taskFailedIcon:i.state.skippedTaskIds.indexOf(n.id)>-1&&(s=i.taskSkippedIcon,l=!1),l&&i.state.skippedTaskIds.indexOf(n.id)>-1&&i.state.skippedTaskIds.splice(i.state.skippedTaskIds.indexOf(n.id),1),e.addLayer(T.marker([n.lat,n.lon],{icon:s}).on("click",function(){if(o.state.selectedTask==n)o.gototask(n.id,n.title);else{if(null!=o.sessionInfo){var e=JSON.stringify({});o.chatAndSessionService.addUserEvent("event_task_previewed",e,n.id.toString())}o.state.selectedTask=n,o.map.panTo([n.lat,n.lon])}}))},i=this,s=0;s<this.taskList.length;s++)n(s);return this.map.addLayer(e),this.markerGroup=e,[2]}})})},TasksMap.prototype.loadMap=function(){return H(this,void 0,void 0,function(){var e,t,n,i,s,o,l,r,a=this;return W(this,function(u){switch(u.label){case 0:return e=this.route.getTilesMap(this.app.activeNarrative),t=this.route.getTilesServerSubdomains(this.app.activeNarrative),null!=this.map?[3,2]:(this.map=T.map("tasks-map",{attributionControl:!1,zoom:18,trackResize:!1,maxBounds:this.route.getBoundingBoxLatLng()}),T.control.attribution({position:"bottomleft",prefix:"Leaflet"}).addTo(this.map),this.map.fitBounds(this.route.getViewBoundingBoxLatLng()),this.map.on("click",function(e){a.state.selectedTask=null}),n=this.map,[4,M.a.initialize()]);case 1:u.sent(),i=w.b.calculateZoom(this.route.getViewBoundingBoxLatLng()),s=T.tileLayer.offline(e,M.a,{attribution:"&copy; mapbox.com",subdomains:t,minZoom:i.min_zoom,maxZoom:i.max_zoom,tileSize:256,crossOrigin:!0,detectRetina:!0,bounds:this.route.getBoundingBoxLatLng()}),this.gpsService.getCurrentPosition().then(function(e){e&&e.coords&&(console.debug("found you"),a.userMarker=T.marker([e.coords.latitude,e.coords.longitude],{icon:a.userPositionIcon}).on("click",function(){}),a.userMarker.setRotationOrigin("center center"),a.userMarker.addTo(a.map),a.watchSubscription&&a.watchSubscription.unsubscribe(),a.watchSubscription=a.gpsService.watchPosition().subscribe(function(e){if(e&&e.coords){var t=new T.LatLng(e.coords.latitude,e.coords.longitude);if(a.map.getBounds().contains(t)){if(a.isUserInsideMap||a.userMarker.setIcon(a.userPositionIcon),a.userMarker.setLatLng(t),null!=a.prevPos){var n=w.b.getAngle(a.prevPos,e.coords);a.userMarker.setRotationAngle(n)}a.isUserInsideMap=!0}else a.isUserInsideMap&&a.userMarker.setIcon(a.userPositionArrow),a.updateUserLocationArrow(t),a.isUserInsideMap=!1;a.prevPos=e.coords}}),a.map.on("moveend",function(e){a.isUserInsideMap||a.updateUserLocationArrow(new T.LatLng(a.prevPos.latitude,a.prevPos.longitude))}))}).catch(function(e){console.error("Location error: "+JSON.stringify(e))}),o=this.ormService.getTileURLsAsObject(this.route),l=!this.route.isNarrativeEnabled(),r=this,s.getTileUrl=function(e){var t=T.TileLayer.prototype.getTileUrl.call(this,e),n=this._getStorageKey(t);return o[n]?Promise.resolve(r.imagesService.getOfflineURL(n,!1,l)):Promise.resolve(t)},s.addTo(n),this.map.fitBounds(this.route.getViewBoundingBoxLatLng()),s.on("offline:below-min-zoom-error",function(){alert("Can not save tiles below minimum zoom level.")}),s.on("offline:save-start",function(e){console.debug(e),console.debug("Saving "+e.nTilesToSave+" tiles.")}),s.on("offline:save-end",function(){alert("All the tiles were saved.")}),s.on("offline:save-error",function(e){console.error("Error when saving tiles: "+e)}),s.on("offline:remove-start",function(){console.debug("Removing tiles.")}),s.on("offline:remove-end",function(){alert("All the tiles were removed.")}),s.on("offline:remove-error",function(e){console.error("Error when removing tiles: "+e)}),null!=this.state.selectedTask&&this.centerSelectedTask(),u.label=2;case 2:return[2]}})})},TasksMap.prototype.updateUserLocationArrow=function(e){if(e){var t=this.map.getBounds(),n=T.GeometryUtil.bearing(this.map.getCenter(),e),i=T.GeometryUtil.bearing(this.map.getCenter(),t.getNorthEast()),s=T.GeometryUtil.length([t.getNorthWest(),t.getNorthEast()])/2,o=T.GeometryUtil.length([t.getSouthWest(),t.getNorthWest()])/2,l=0;n<0&&(n+=360),l=n>=i&&n<=180-i||n>=180+i&&n<=360-i?Math.abs(s/Math.sin(n*(Math.PI/180))):Math.abs(o/Math.cos(n*(Math.PI/180)));var r=T.GeometryUtil.destination(this.map.getCenter(),n,.9*l);this.userMarker.setLatLng(r),this.userMarker.setRotationAngle(n)}},TasksMap.prototype.centerSelectedTask=function(){this.map.panTo([this.state.selectedTask.lat,this.state.selectedTask.lon])},TasksMap.prototype.goToNextTaskById=function(e,t){var n=this;this.taskList.forEach(function(i){i.id!=e||n.goToNextTask(i,t)})},TasksMap.prototype.goToNextTask=function(e,t){t&&this.state.skippedTaskIds.push(e.id),this.state.selectedTask=this.taskList[e.position%this.taskList.length],this.state.visibleTasks[this.state.selectedTask.position]=!0,this.centerSelectedTask(),this.saveMapStateToLocalStorage()},TasksMap.prototype.selectStartPoint=function(){return H(this,void 0,void 0,function(){var e;return W(this,function(t){return e=this,console.log("Active Narrative is: "+this.app.activeNarrative),[2,this.modalsService.presentTaskListModal(this.route,this.score,this.state,this.app.activeNarrative,this.navCtrl,function(t){if(console.debug("back in tasksMap"),e.state.selectedTask=t,e.state.visibleTasks={},e.state.visibleTasks[t.position]=!0,e.state.isShowingAllTasks=!1,e.centerSelectedTask(),e.redrawMarker(),null!=e.sessionInfo){var n=JSON.stringify({title:e.state.selectedTask.title});e.chatAndSessionService.addUserEvent("event_trail_start_from_task",n,e.state.selectedTask.id.toString())}})]})})},TasksMap.prototype.showAllTasks=function(){this.state.isShowingAllTasks=!0,this.redrawMarker()},TasksMap.prototype.displayResetTasksModal=function(){var e=this;this.modalsService.showDialog("a_route_detail_settings_resetTasks","a_route_detail_settings_resetTasks_msg","no",function(){},"yes",function(){return H(e,void 0,void 0,function(){return W(this,function(e){switch(e.label){case 0:return[4,this.resetTasks()];case 1:return e.sent(),this.showGuidedTrailModalWithDelay(50),[2]}})})},this.app.activeNarrative)},TasksMap.prototype.resetTasks=function(){var e=this;return new Promise(function(t){e.ormService.deleteUserScore(e.score).then(function(){return H(e,void 0,void 0,function(){var e;return W(this,function(n){switch(n.label){case 0:return this.score=new x.a,this.state=this.navParams.data.tasksMapState={selectedTask:null,isShowingAllTasks:!0,visibleTasks:{},skippedTaskIds:[],selectedStartTask:!1,showIntroModal:!0,showGuidedTrailModal:!0},this.taskList?[3,2]:(e=this,[4,this.route.getTasks()]);case 1:e.taskList=n.sent(),n.label=2;case 2:return null!=this.sessionInfo&&0!=this.sessionInfo.sessionUser.assigned_task_id&&this.forceStartFromTask(this.sessionInfo.sessionUser.assigned_task_id),this.route.completed=!1,this.route.completedDate=null,[4,this.saveMapStateToLocalStorage()];case 3:return n.sent(),[4,this.ormService.saveAndFireChangedEvent(this.route)];case 4:return n.sent(),[4,this.redrawMarker()];case 5:return n.sent(),t(),[2]}})})})})},TasksMap.prototype.sessionFinished=function(){return H(this,void 0,void 0,function(){var e=this;return W(this,function(t){return this.modalsService.showDialog("a_private_session_quit","a_private_session_quit_text","no",function(){},"yes",function(){if(e.modalCtrl.create(G.a,{session:e.sessionInfo.session,score:e.score,tasks:e.taskList,narrative:e.app.activeNarrative},{cssClass:e.app.activeNarrative}).present(),null!=e.sessionInfo){var t=JSON.stringify({});e.chatAndSessionService.addUserEvent("event_session_leave",t,"0")}e.chatAndSessionService.exitActiveSession(),e.sessionTimeSubscription&&e.sessionTimeSubscription.unsubscribe()},this.app.activeNarrative),[2]})})},TasksMap.prototype.sessionKicked=function(){return H(this,void 0,void 0,function(){var e,t;return W(this,function(n){return e=this,(t=this.modalCtrl.create(B.a,{title:"a_private_session_kicked",message:"a_private_session_kicked_text",modalType:N.a.hint,type:"text",gamificationEnabled:!1,narrativeEnabled:this.route.isNarrativeEnabled(),narrative:this.app.activeNarrative,buttons:[{title:"a_g_ok",callback:function(){t.dismiss();var n=e.modalCtrl.create(G.a,{session:e.sessionInfo.session,score:e.score,tasks:e.taskList,narrative:this.app.activeNarrative},{showBackdrop:!0,enableBackdropDismiss:!1});null!=e.sessionInfo&&e.chatAndSessionService.exitActiveSession(),e.sessionTimeSubscription&&e.sessionTimeSubscription.unsubscribe(),n.present()}}]},{showBackdrop:!0,enableBackdropDismiss:!0,cssClass:this.app.activeNarrative})).present(),[2]})})},TasksMap.prototype.gototask=function(e,t){return H(this,void 0,void 0,function(){var n,i=this;return W(this,function(s){return this.taskBlocked?(console.log("session in preparation."),[2]):(console.debug("taskId",e),n=this,this.navCtrl.push("TaskDetail",{taskId:e,headerTitle:t,routeId:this.routeId,goToNextTaskById:function(e,t){n.goToNextTaskById(e,t)}},{},function(){i.deepLinker.navChange("forward")}),[2])})})},TasksMap.prototype.navigateToChat=function(){return H(this,void 0,void 0,function(){var e;return W(this,function(t){return console.debug("showChat"),null!=this.sessionInfo&&(e=JSON.stringify({}),this.chatAndSessionService.addUserEvent("event_trail_chat_open",e,"0")),this.navCtrl.push(D.a,{val:"chatseite",headerTitle:this.sessionInfo.session.name}),[2]})})},TasksMap.prototype.sessionTime=function(){if(null==this.sessionInfo)return this.startInterval=!1,void(this.sessionTimeSubscription&&this.sessionTimeSubscription.unsubscribe());var e=this.sessionInfo.session,t=F().unix(),n=F(e.starts_at).unix(),i=F(e.ends_at).unix(),s=n-t,o=Math.floor(s/60),l=Math.floor((i-t)/60);if(t>n-3600&&t<i)this.startInterval=!0,t<n&&t<i&&(this.showCountdownOrTimer=!0,this.countdownBeforeSession=!0,this.countdownOrTimerForSession=o,this.taskBlocked=!0),t>n&&t<i&&(this.showCountdownOrTimer=!0,this.countdownOrTimerForSession=l,this.countdownBeforeSession=!1,this.taskBlocked=!1);else{this.startInterval=!1,this.sessionTimeSubscription&&this.sessionTimeSubscription.unsubscribe(),this.showSessionEnds=!0,this.taskBlocked=!1;this.modalCtrl.create(G.a,{session:this.sessionInfo.session,score:this.score,tasks:this.taskList,narrative:this.app.activeNarrative},{cssClass:this.app.activeNarrative}).present()}},TasksMap.prototype.showIntroModal=function(){var e=this;return new Promise(function(t){var n="a_alert_welcome",i="a_alert_welcome_msg";e.route.isNarrativeEnabled()&&(n=e.route.getNarrativeString(n),i=e.route.getNarrativeString(i));var s=e.modalCtrl.create(U.a,{title:n,message:i,modalType:N.a.hint,narrative:e.app.activeNarrative,buttons:[{title:"a_alert_close",callback:function(){s.dismiss(),t()}}]},{cssClass:e.app.activeNarrative});s.present()})},TasksMap.prototype.updateIcons=function(){switch(this.app.activeNarrative){case"pirates":this.userPositionIcon=T.icon({iconUrl:"./assets/icons/pirates/mapposition.png",iconSize:[100,100],iconAnchor:[50,50],className:"marker userPosition"}),this.userPositionArrow=T.icon({iconUrl:"./assets/icons/userDirection.png",iconSize:[36,36],iconAnchor:[18,18],className:"marker userArrow"}),this.taskOpenIcon=T.icon({iconUrl:"assets/icons/pirates/marker-task-open.png",iconSize:[50,50],iconAnchor:[25,25],className:"marker"}),this.taskSkippedIcon=T.icon({iconUrl:"assets/icons/pirates/marker-task-skipped.png",iconSize:[50,50],iconAnchor:[25,25],className:"marker"}),this.taskSavedIcon=T.icon({iconUrl:"assets/icons/marker-task-saved.png",iconSize:[35,48],iconAnchor:[17.5,43],className:"marker"}),this.taskDoneIcon=T.icon({iconUrl:"assets/icons/pirates/marker-task-good.png",iconSize:[50,50],iconAnchor:[25,25],className:"marker"}),this.taskDonePerfectIcon=T.icon({iconUrl:"assets/icons/pirates/marker-task-perfect.png",iconSize:[50,50],iconAnchor:[25,25],className:"marker"}),this.taskFailedIcon=T.icon({iconUrl:"assets/icons/pirates/marker-task-failed.png",iconSize:[50,50],iconAnchor:[25,25],className:"marker"}),this.taskOpenIcon.clusterColor="#AA2000",this.taskSkippedIcon.clusterColor="#b2b2b2",this.taskSavedIcon.clusterColor="#6E38B9",this.taskDoneIcon.clusterColor="#FFC033",this.taskDonePerfectIcon.clusterColor="#33CC00",this.taskFailedIcon.clusterColor="#333333";break;default:this.userPositionIcon=T.icon({iconUrl:"./assets/icons/mapposition.png",iconSize:[100,100],iconAnchor:[50,50],className:"marker userPosition"}),this.userPositionArrow=T.icon({iconUrl:"./assets/icons/userDirection.png",iconSize:[36,36],iconAnchor:[18,18],className:"marker userArrow"}),this.taskOpenIcon=T.icon({iconUrl:"assets/icons/marker-task-open.png",iconSize:[35,48],iconAnchor:[17.5,43],className:"marker"}),this.taskSkippedIcon=T.icon({iconUrl:"assets/icons/marker-task-skipped.png",iconSize:[35,48],iconAnchor:[17.5,43],className:"marker"}),this.taskSavedIcon=T.icon({iconUrl:"assets/icons/marker-task-saved.png",iconSize:[35,48],iconAnchor:[17.5,43],className:"marker"}),this.taskDoneIcon=T.icon({iconUrl:"assets/icons/marker-task-good.png",iconSize:[35,48],iconAnchor:[17.5,43],className:"marker"}),this.taskDonePerfectIcon=T.icon({iconUrl:"assets/icons/marker-task-perfect.png",iconSize:[35,48],iconAnchor:[17.5,43],className:"marker"}),this.taskFailedIcon=T.icon({iconUrl:"assets/icons/marker-task-failed.png",iconSize:[35,48],iconAnchor:[17.5,43],className:"marker"}),this.taskOpenIcon.clusterColor="#036D99",this.taskSkippedIcon.clusterColor="#B2B2B2",this.taskSavedIcon.clusterColor="#6E38B9",this.taskDoneIcon.clusterColor="#F3B100",this.taskDonePerfectIcon.clusterColor="#4CAF50",this.taskFailedIcon.clusterColor="#E62B25"}},TasksMap.UPDATE_SESSION_TIME_INTERVAL_IN_SECS=15,TasksMap;var e}(),K=n(188),J=function(){return function(){}}(),$=n(605),Q=n(606),X=n(607),Y=n(608),ee=n(609),te=n(610),ne=n(611),ie=n(612),se=n(613),oe=n(49),le=n(4),re=n(38),ae=n(22),ue=n(95),ce=n(93),de=n(12),he=n(94),pe=n(934),fe=n(137),_e=n(77),me=n(25),ge=n(18),ve=n(278),ke=n(141),ye=n(24),Le=n(13),be=n(6),Se=n(276),Ce=n(35),Te=n(8),we=n(14),Me=n(11),Ie=n(54),xe=n(933),Re=n(277),Ae=n(198),Oe=n(113),Pe=n(193),Ee=S["ɵcrt"]({encapsulation:2,styles:[],data:{}}),Ne=S["ɵccf"]("page-tasks-map",q,function(e){return S["ɵvid"](0,[(e()(),S["ɵeld"](0,null,null,1,"page-tasks-map",[],null,null,null,b,Ee)),S["ɵdid"](245760,null,0,q,[ye.a,Le.a,Oe.a,I.a,R.a,A.a,O.a,P.a,Pe.a,E.a,z.a,Z.a,N.b,w.b],null,null)],function(e,t){e(t,1,0)},null)},{},{},[]),Be=n(23),Ue=n(76),ze=n(142),Ge=n(143),De=n(145),Ze=n(144),Fe=n(189),Ve=n(275),je=n(91);n.d(t,"TasksMapPageModuleNgFactory",function(){return He});var He=S["ɵcmf"](J,[],function(e){return S["ɵmod"]([S["ɵmpd"](512,S.ComponentFactoryResolver,S["ɵCodegenComponentFactoryResolver"],[[8,[$.a,Q.a,X.a,Y.a,ee.a,te.a,ne.a,ie.a,se.a,Ne]],[3,S.ComponentFactoryResolver],S.NgModuleRef]),S["ɵmpd"](4608,de.m,de.l,[S.LOCALE_ID]),S["ɵmpd"](4608,Be.k,Be.k,[]),S["ɵmpd"](4608,Be.c,Be.c,[]),S["ɵmpd"](4608,Ue.a,Ue.a,[]),S["ɵmpd"](4608,ze.b,ze.a,[]),S["ɵmpd"](4608,Ge.a,Ge.b,[]),S["ɵmpd"](4608,De.b,De.a,[]),S["ɵmpd"](4608,Ze.b,Ze.a,[]),S["ɵmpd"](4608,ae.a,ae.a,[Fe.a,ze.b,Ge.a,De.b,Ze.b,ae.b,ae.c]),S["ɵmpd"](512,de.b,de.b,[]),S["ɵmpd"](512,Be.j,Be.j,[]),S["ɵmpd"](512,Be.d,Be.d,[]),S["ɵmpd"](512,Be.i,Be.i,[]),S["ɵmpd"](512,Ve.a,Ve.a,[]),S["ɵmpd"](512,Ve.b,Ve.b,[]),S["ɵmpd"](512,C.a,C.a,[]),S["ɵmpd"](512,K.a,K.a,[]),S["ɵmpd"](512,J,J,[]),S["ɵmpd"](256,je.a,q,[]),S["ɵmpd"](256,ae.c,void 0,[]),S["ɵmpd"](256,ae.b,void 0,[])])})},933:function(e,t,n){"use strict";function i(e){return s["ɵvid"](0,[s["ɵncd"](null,0)],null,null)}n.d(t,"a",function(){return o}),t.b=i;var s=n(1),o=s["ɵcrt"]({encapsulation:2,styles:[],data:{}})},934:function(e,t,n){"use strict";function i(e){return s["ɵvid"](2,[(e()(),s["ɵeld"](0,null,null,1,"ion-icon",[["class","fab-close-icon"],["name","close"],["role","img"]],[[2,"hide",null]],null,null,null,null)),s["ɵdid"](147456,null,0,o.a,[l.a,s.ElementRef,s.Renderer],{name:[0,"name"]},null),(e()(),s["ɵeld"](0,null,null,1,"span",[["class","button-inner"]],null,null,null,null,null)),s["ɵncd"](null,0),(e()(),s["ɵeld"](0,null,null,0,"div",[["class","button-effect"]],null,null,null,null,null))],function(e,t){e(t,1,0,"close")},function(e,t){e(t,0,0,s["ɵnov"](t,1)._hidden)})}n.d(t,"a",function(){return r}),t.b=i;var s=n(1),o=n(77),l=n(4),r=s["ɵcrt"]({encapsulation:2,styles:[],data:{}})},935:function(e,t){!function(e,t,n){L.MarkerClusterGroup=L.FeatureGroup.extend({options:{maxClusterRadius:80,iconCreateFunction:null,spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,singleMarkerMode:!1,disableClusteringAtZoom:null,removeOutsideVisibleBounds:!0,animate:!0,animateAddingMarkers:!1,spiderfyDistanceMultiplier:1,spiderLegPolylineOptions:{weight:1.5,color:"#222",opacity:.5},chunkedLoading:!1,chunkInterval:200,chunkDelay:50,chunkProgress:null,polygonOptions:{}},initialize:function(e){L.Util.setOptions(this,e),this.options.iconCreateFunction||(this.options.iconCreateFunction=this._defaultIconCreateFunction),this.options.clusterPane||(this.options.clusterPane=L.Marker.prototype.options.pane),this._featureGroup=L.featureGroup(),this._featureGroup.addEventParent(this),this._nonPointGroup=L.featureGroup(),this._nonPointGroup.addEventParent(this),this._inZoomAnimation=0,this._needsClustering=[],this._needsRemoving=[],this._currentShownBounds=null,this._queue=[],this._childMarkerEventHandlers={dragstart:this._childMarkerDragStart,move:this._childMarkerMoved,dragend:this._childMarkerDragEnd};var t=L.DomUtil.TRANSITION&&this.options.animate;L.extend(this,t?this._withAnimation:this._noAnimation),this._markerCluster=t?L.MarkerCluster:L.MarkerClusterNonAnimated},addLayer:function(e){if(e instanceof L.LayerGroup)return this.addLayers([e]);if(!e.getLatLng)return this._nonPointGroup.addLayer(e),this.fire("layeradd",{layer:e}),this;if(!this._map)return this._needsClustering.push(e),this.fire("layeradd",{layer:e}),this;if(this.hasLayer(e))return this;this._unspiderfy&&this._unspiderfy(),this._addLayer(e,this._maxZoom),this.fire("layeradd",{layer:e}),this._topClusterLevel._recalculateBounds(),this._refreshClustersIcons();var t=e,n=this._zoom;if(e.__parent)for(;t.__parent._zoom>=n;)t=t.__parent;return this._currentShownBounds.contains(t.getLatLng())&&(this.options.animateAddingMarkers?this._animationAddLayer(e,t):this._animationAddLayerNonAnimated(e,t)),this},removeLayer:function(e){return e instanceof L.LayerGroup?this.removeLayers([e]):e.getLatLng?this._map?e.__parent?(this._unspiderfy&&(this._unspiderfy(),this._unspiderfyLayer(e)),this._removeLayer(e,!0),this.fire("layerremove",{layer:e}),this._topClusterLevel._recalculateBounds(),this._refreshClustersIcons(),e.off(this._childMarkerEventHandlers,this),this._featureGroup.hasLayer(e)&&(this._featureGroup.removeLayer(e),e.clusterShow&&e.clusterShow()),this):this:(!this._arraySplice(this._needsClustering,e)&&this.hasLayer(e)&&this._needsRemoving.push({layer:e,latlng:e._latlng}),this.fire("layerremove",{layer:e}),this):(this._nonPointGroup.removeLayer(e),this.fire("layerremove",{layer:e}),this)},addLayers:function(e,t){if(!L.Util.isArray(e))return this.addLayer(e);var n,i=this._featureGroup,s=this._nonPointGroup,o=this.options.chunkedLoading,l=this.options.chunkInterval,r=this.options.chunkProgress,a=e.length,u=0,c=!0;if(this._map){var d=(new Date).getTime(),h=L.bind(function(){for(var p=(new Date).getTime();a>u;u++){if(o&&0==u%200){if((new Date).getTime()-p>l)break}if((n=e[u])instanceof L.LayerGroup)c&&(e=e.slice(),c=!1),this._extractNonGroupLayers(n,e),a=e.length;else if(n.getLatLng){if(!this.hasLayer(n)&&(this._addLayer(n,this._maxZoom),t||this.fire("layeradd",{layer:n}),n.__parent&&2===n.__parent.getChildCount())){var f=n.__parent.getAllChildMarkers();i.removeLayer(f[0]===n?f[1]:f[0])}}else s.addLayer(n),t||this.fire("layeradd",{layer:n})}r&&r(u,a,(new Date).getTime()-d),u===a?(this._topClusterLevel._recalculateBounds(),this._refreshClustersIcons(),this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds)):setTimeout(h,this.options.chunkDelay)},this);h()}else for(var p=this._needsClustering;a>u;u++)(n=e[u])instanceof L.LayerGroup?(c&&(e=e.slice(),c=!1),this._extractNonGroupLayers(n,e),a=e.length):n.getLatLng?this.hasLayer(n)||p.push(n):s.addLayer(n);return this},removeLayers:function(e){var t,n,i=e.length,s=this._featureGroup,o=this._nonPointGroup,l=!0;if(!this._map){for(t=0;i>t;t++)(n=e[t])instanceof L.LayerGroup?(l&&(e=e.slice(),l=!1),this._extractNonGroupLayers(n,e),i=e.length):(this._arraySplice(this._needsClustering,n),o.removeLayer(n),this.hasLayer(n)&&this._needsRemoving.push({layer:n,latlng:n._latlng}),this.fire("layerremove",{layer:n}));return this}if(this._unspiderfy){this._unspiderfy();var r=e.slice(),a=i;for(t=0;a>t;t++)(n=r[t])instanceof L.LayerGroup?(this._extractNonGroupLayers(n,r),a=r.length):this._unspiderfyLayer(n)}for(t=0;i>t;t++)(n=e[t])instanceof L.LayerGroup?(l&&(e=e.slice(),l=!1),this._extractNonGroupLayers(n,e),i=e.length):n.__parent?(this._removeLayer(n,!0,!0),this.fire("layerremove",{layer:n}),s.hasLayer(n)&&(s.removeLayer(n),n.clusterShow&&n.clusterShow())):(o.removeLayer(n),this.fire("layerremove",{layer:n}));return this._topClusterLevel._recalculateBounds(),this._refreshClustersIcons(),this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds),this},clearLayers:function(){return this._map||(this._needsClustering=[],delete this._gridClusters,delete this._gridUnclustered),this._noanimationUnspiderfy&&this._noanimationUnspiderfy(),this._featureGroup.clearLayers(),this._nonPointGroup.clearLayers(),this.eachLayer(function(e){e.off(this._childMarkerEventHandlers,this),delete e.__parent},this),this._map&&this._generateInitialClusters(),this},getBounds:function(){var e=new L.LatLngBounds;this._topClusterLevel&&e.extend(this._topClusterLevel._bounds);for(var t=this._needsClustering.length-1;t>=0;t--)e.extend(this._needsClustering[t].getLatLng());return e.extend(this._nonPointGroup.getBounds()),e},eachLayer:function(e,t){var n,i,s,o=this._needsClustering.slice(),l=this._needsRemoving;for(this._topClusterLevel&&this._topClusterLevel.getAllChildMarkers(o),i=o.length-1;i>=0;i--){for(n=!0,s=l.length-1;s>=0;s--)if(l[s].layer===o[i]){n=!1;break}n&&e.call(t,o[i])}this._nonPointGroup.eachLayer(e,t)},getLayers:function(){var e=[];return this.eachLayer(function(t){e.push(t)}),e},getLayer:function(e){var t=null;return e=parseInt(e,10),this.eachLayer(function(n){L.stamp(n)===e&&(t=n)}),t},hasLayer:function(e){if(!e)return!1;var t,n=this._needsClustering;for(t=n.length-1;t>=0;t--)if(n[t]===e)return!0;for(t=(n=this._needsRemoving).length-1;t>=0;t--)if(n[t].layer===e)return!1;return!(!e.__parent||e.__parent._group!==this)||this._nonPointGroup.hasLayer(e)},zoomToShowLayer:function(e,t){"function"!=typeof t&&(t=function(){});var n=function(){!e._icon&&!e.__parent._icon||this._inZoomAnimation||(this._map.off("moveend",n,this),this.off("animationend",n,this),e._icon?t():e.__parent._icon&&(this.once("spiderfied",t,this),e.__parent.spiderfy()))};e._icon&&this._map.getBounds().contains(e.getLatLng())?t():e.__parent._zoom<Math.round(this._map._zoom)?(this._map.on("moveend",n,this),this._map.panTo(e.getLatLng())):(this._map.on("moveend",n,this),this.on("animationend",n,this),e.__parent.zoomToBounds())},onAdd:function(e){this._map=e;var t,n,i;if(!isFinite(this._map.getMaxZoom()))throw"Map has no maxZoom specified";for(this._featureGroup.addTo(e),this._nonPointGroup.addTo(e),this._gridClusters||this._generateInitialClusters(),this._maxLat=e.options.crs.projection.MAX_LATITUDE,t=0,n=this._needsRemoving.length;n>t;t++)i=this._needsRemoving[t],i.newlatlng=i.layer._latlng,i.layer._latlng=i.latlng;for(t=0,n=this._needsRemoving.length;n>t;t++)i=this._needsRemoving[t],this._removeLayer(i.layer,!0),i.layer._latlng=i.newlatlng;this._needsRemoving=[],this._zoom=Math.round(this._map._zoom),this._currentShownBounds=this._getExpandedVisibleBounds(),this._map.on("zoomend",this._zoomEnd,this),this._map.on("moveend",this._moveEnd,this),this._spiderfierOnAdd&&this._spiderfierOnAdd(),this._bindEvents(),n=this._needsClustering,this._needsClustering=[],this.addLayers(n,!0)},onRemove:function(e){e.off("zoomend",this._zoomEnd,this),e.off("moveend",this._moveEnd,this),this._unbindEvents(),this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim",""),this._spiderfierOnRemove&&this._spiderfierOnRemove(),delete this._maxLat,this._hideCoverage(),this._featureGroup.remove(),this._nonPointGroup.remove(),this._featureGroup.clearLayers(),this._map=null},getVisibleParent:function(e){for(var t=e;t&&!t._icon;)t=t.__parent;return t||null},_arraySplice:function(e,t){for(var n=e.length-1;n>=0;n--)if(e[n]===t)return e.splice(n,1),!0},_removeFromGridUnclustered:function(e,t){for(var n=this._map,i=this._gridUnclustered,s=Math.floor(this._map.getMinZoom());t>=s&&i[t].removeObject(e,n.project(e.getLatLng(),t));t--);},_childMarkerDragStart:function(e){e.target.__dragStart=e.target._latlng},_childMarkerMoved:function(e){if(!this._ignoreMove&&!e.target.__dragStart){var t=e.target._popup&&e.target._popup.isOpen();this._moveChild(e.target,e.oldLatLng,e.latlng),t&&e.target.openPopup()}},_moveChild:function(e,t,n){e._latlng=t,this.removeLayer(e),e._latlng=n,this.addLayer(e)},_childMarkerDragEnd:function(e){e.target.__dragStart&&this._moveChild(e.target,e.target.__dragStart,e.target._latlng),delete e.target.__dragStart},_removeLayer:function(e,t,n){var i=this._gridClusters,s=this._gridUnclustered,o=this._featureGroup,l=this._map,r=Math.floor(this._map.getMinZoom());t&&this._removeFromGridUnclustered(e,this._maxZoom);var a,u=e.__parent;for(this._arraySplice(u._markers,e);u&&(u._childCount--,u._boundsNeedUpdate=!0,!(u._zoom<r));)t&&u._childCount<=1?(a=u._markers[0]===e?u._markers[1]:u._markers[0],i[u._zoom].removeObject(u,l.project(u._cLatLng,u._zoom)),s[u._zoom].addObject(a,l.project(a.getLatLng(),u._zoom)),this._arraySplice(u.__parent._childClusters,u),u.__parent._markers.push(a),a.__parent=u.__parent,u._icon&&(o.removeLayer(u),n||o.addLayer(a))):u._iconNeedsUpdate=!0,u=u.__parent;delete e.__parent},_isOrIsParent:function(e,t){for(;t;){if(e===t)return!0;t=t.parentNode}return!1},fire:function(e,t,n){if(t&&t.layer instanceof L.MarkerCluster){if(t.originalEvent&&this._isOrIsParent(t.layer._icon,t.originalEvent.relatedTarget))return;e="cluster"+e}L.FeatureGroup.prototype.fire.call(this,e,t,n)},listens:function(e,t){return L.FeatureGroup.prototype.listens.call(this,e,t)||L.FeatureGroup.prototype.listens.call(this,"cluster"+e,t)},_defaultIconCreateFunction:function(e){var t=e.getChildCount(),n=" marker-cluster-";return n+=10>t?"small":100>t?"medium":"large",new L.DivIcon({html:"<div><span>"+t+"</span></div>",className:"marker-cluster"+n,iconSize:new L.Point(40,40)})},_bindEvents:function(){var e=this._map,t=this.options.showCoverageOnHover;(this.options.spiderfyOnMaxZoom||this.options.zoomToBoundsOnClick)&&this.on("clusterclick",this._zoomOrSpiderfy,this),t&&(this.on("clustermouseover",this._showCoverage,this),this.on("clustermouseout",this._hideCoverage,this),e.on("zoomend",this._hideCoverage,this))},_zoomOrSpiderfy:function(e){for(var t=e.layer,n=t;1===n._childClusters.length;)n=n._childClusters[0];n._zoom===this._maxZoom&&n._childCount===t._childCount&&this.options.spiderfyOnMaxZoom?t.spiderfy():this.options.zoomToBoundsOnClick&&t.zoomToBounds(),e.originalEvent&&13===e.originalEvent.keyCode&&this._map._container.focus()},_showCoverage:function(e){var t=this._map;this._inZoomAnimation||(this._shownPolygon&&t.removeLayer(this._shownPolygon),e.layer.getChildCount()>2&&e.layer!==this._spiderfied&&(this._shownPolygon=new L.Polygon(e.layer.getConvexHull(),this.options.polygonOptions),t.addLayer(this._shownPolygon)))},_hideCoverage:function(){this._shownPolygon&&(this._map.removeLayer(this._shownPolygon),this._shownPolygon=null)},_unbindEvents:function(){var e=this.options.showCoverageOnHover,t=this._map;(this.options.spiderfyOnMaxZoom||this.options.zoomToBoundsOnClick)&&this.off("clusterclick",this._zoomOrSpiderfy,this),e&&(this.off("clustermouseover",this._showCoverage,this),this.off("clustermouseout",this._hideCoverage,this),t.off("zoomend",this._hideCoverage,this))},_zoomEnd:function(){this._map&&(this._mergeSplitClusters(),this._zoom=Math.round(this._map._zoom),this._currentShownBounds=this._getExpandedVisibleBounds())},_moveEnd:function(){if(!this._inZoomAnimation){var e=this._getExpandedVisibleBounds();this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,Math.floor(this._map.getMinZoom()),this._zoom,e),this._topClusterLevel._recursivelyAddChildrenToMap(null,Math.round(this._map._zoom),e),this._currentShownBounds=e}},_generateInitialClusters:function(){var e=Math.ceil(this._map.getMaxZoom()),t=Math.floor(this._map.getMinZoom()),n=this.options.maxClusterRadius,i=n;"function"!=typeof n&&(i=function(){return n}),null!==this.options.disableClusteringAtZoom&&(e=this.options.disableClusteringAtZoom-1),this._maxZoom=e,this._gridClusters={},this._gridUnclustered={};for(var s=e;s>=t;s--)this._gridClusters[s]=new L.DistanceGrid(i(s)),this._gridUnclustered[s]=new L.DistanceGrid(i(s));this._topClusterLevel=new this._markerCluster(this,t-1)},_addLayer:function(e,t){var n,i,s=this._gridClusters,o=this._gridUnclustered,l=Math.floor(this._map.getMinZoom());for(this.options.singleMarkerMode&&this._overrideMarkerIcon(e),e.on(this._childMarkerEventHandlers,this);t>=l;t--){n=this._map.project(e.getLatLng(),t);var r=s[t].getNearObject(n);if(r)return r._addChild(e),void(e.__parent=r);if(r=o[t].getNearObject(n)){var a=r.__parent;a&&this._removeLayer(r,!1);var u=new this._markerCluster(this,t,r,e);s[t].addObject(u,this._map.project(u._cLatLng,t)),r.__parent=u,e.__parent=u;var c=u;for(i=t-1;i>a._zoom;i--)c=new this._markerCluster(this,i,c),s[i].addObject(c,this._map.project(r.getLatLng(),i));return a._addChild(c),void this._removeFromGridUnclustered(r,t)}o[t].addObject(e,n)}this._topClusterLevel._addChild(e),e.__parent=this._topClusterLevel},_refreshClustersIcons:function(){this._featureGroup.eachLayer(function(e){e instanceof L.MarkerCluster&&e._iconNeedsUpdate&&e._updateIcon()})},_enqueue:function(e){this._queue.push(e),this._queueTimeout||(this._queueTimeout=setTimeout(L.bind(this._processQueue,this),300))},_processQueue:function(){for(var e=0;e<this._queue.length;e++)this._queue[e].call(this);this._queue.length=0,clearTimeout(this._queueTimeout),this._queueTimeout=null},_mergeSplitClusters:function(){var e=Math.round(this._map._zoom);this._processQueue(),this._zoom<e&&this._currentShownBounds.intersects(this._getExpandedVisibleBounds())?(this._animationStart(),this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,Math.floor(this._map.getMinZoom()),this._zoom,this._getExpandedVisibleBounds()),this._animationZoomIn(this._zoom,e)):this._zoom>e?(this._animationStart(),this._animationZoomOut(this._zoom,e)):this._moveEnd()},_getExpandedVisibleBounds:function(){return this.options.removeOutsideVisibleBounds?L.Browser.mobile?this._checkBoundsMaxLat(this._map.getBounds()):this._checkBoundsMaxLat(this._map.getBounds().pad(1)):this._mapBoundsInfinite},_checkBoundsMaxLat:function(e){var t=this._maxLat;return void 0!==t&&(e.getNorth()>=t&&(e._northEast.lat=1/0),e.getSouth()<=-t&&(e._southWest.lat=-1/0)),e},_animationAddLayerNonAnimated:function(e,t){if(t===e)this._featureGroup.addLayer(e);else if(2===t._childCount){t._addToMap();var n=t.getAllChildMarkers();this._featureGroup.removeLayer(n[0]),this._featureGroup.removeLayer(n[1])}else t._updateIcon()},_extractNonGroupLayers:function(e,t){var n,i=e.getLayers(),s=0;for(t=t||[];s<i.length;s++)(n=i[s])instanceof L.LayerGroup?this._extractNonGroupLayers(n,t):t.push(n);return t},_overrideMarkerIcon:function(e){return e.options.icon=this.options.iconCreateFunction({getChildCount:function(){return 1},getAllChildMarkers:function(){return[e]}})}}),L.MarkerClusterGroup.include({_mapBoundsInfinite:new L.LatLngBounds(new L.LatLng(-1/0,-1/0),new L.LatLng(1/0,1/0))}),L.MarkerClusterGroup.include({_noAnimation:{_animationStart:function(){},_animationZoomIn:function(e,t){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,Math.floor(this._map.getMinZoom()),e),this._topClusterLevel._recursivelyAddChildrenToMap(null,t,this._getExpandedVisibleBounds()),this.fire("animationend")},_animationZoomOut:function(e,t){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,Math.floor(this._map.getMinZoom()),e),this._topClusterLevel._recursivelyAddChildrenToMap(null,t,this._getExpandedVisibleBounds()),this.fire("animationend")},_animationAddLayer:function(e,t){this._animationAddLayerNonAnimated(e,t)}},_withAnimation:{_animationStart:function(){this._map._mapPane.className+=" leaflet-cluster-anim",this._inZoomAnimation++},_animationZoomIn:function(e,t){var n,i=this._getExpandedVisibleBounds(),s=this._featureGroup,o=Math.floor(this._map.getMinZoom());this._ignoreMove=!0,this._topClusterLevel._recursively(i,e,o,function(o){var l,r=o._latlng,a=o._markers;for(i.contains(r)||(r=null),o._isSingleParent()&&e+1===t?(s.removeLayer(o),o._recursivelyAddChildrenToMap(null,t,i)):(o.clusterHide(),o._recursivelyAddChildrenToMap(r,t,i)),n=a.length-1;n>=0;n--)l=a[n],i.contains(l._latlng)||s.removeLayer(l)}),this._forceLayout(),this._topClusterLevel._recursivelyBecomeVisible(i,t),s.eachLayer(function(e){e instanceof L.MarkerCluster||!e._icon||e.clusterShow()}),this._topClusterLevel._recursively(i,e,t,function(e){e._recursivelyRestoreChildPositions(t)}),this._ignoreMove=!1,this._enqueue(function(){this._topClusterLevel._recursively(i,e,o,function(e){s.removeLayer(e),e.clusterShow()}),this._animationEnd()})},_animationZoomOut:function(e,t){this._animationZoomOutSingle(this._topClusterLevel,e-1,t),this._topClusterLevel._recursivelyAddChildrenToMap(null,t,this._getExpandedVisibleBounds()),this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,Math.floor(this._map.getMinZoom()),e,this._getExpandedVisibleBounds())},_animationAddLayer:function(e,t){var n=this,i=this._featureGroup;i.addLayer(e),t!==e&&(t._childCount>2?(t._updateIcon(),this._forceLayout(),this._animationStart(),e._setPos(this._map.latLngToLayerPoint(t.getLatLng())),e.clusterHide(),this._enqueue(function(){i.removeLayer(e),e.clusterShow(),n._animationEnd()})):(this._forceLayout(),n._animationStart(),n._animationZoomOutSingle(t,this._map.getMaxZoom(),this._zoom)))}},_animationZoomOutSingle:function(e,t,n){var i=this._getExpandedVisibleBounds(),s=Math.floor(this._map.getMinZoom());e._recursivelyAnimateChildrenInAndAddSelfToMap(i,s,t+1,n);var o=this;this._forceLayout(),e._recursivelyBecomeVisible(i,n),this._enqueue(function(){if(1===e._childCount){var l=e._markers[0];this._ignoreMove=!0,l.setLatLng(l.getLatLng()),this._ignoreMove=!1,l.clusterShow&&l.clusterShow()}else e._recursively(i,n,s,function(e){e._recursivelyRemoveChildrenFromMap(i,s,t+1)});o._animationEnd()})},_animationEnd:function(){this._map&&(this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim","")),this._inZoomAnimation--,this.fire("animationend")},_forceLayout:function(){L.Util.falseFn(t.body.offsetWidth)}}),L.markerClusterGroup=function(e){return new L.MarkerClusterGroup(e)},L.MarkerCluster=L.Marker.extend({initialize:function(e,t,n,i){L.Marker.prototype.initialize.call(this,n?n._cLatLng||n.getLatLng():new L.LatLng(0,0),{icon:this,pane:e.options.clusterPane}),this._group=e,this._zoom=t,this._markers=[],this._childClusters=[],this._childCount=0,this._iconNeedsUpdate=!0,this._boundsNeedUpdate=!0,this._bounds=new L.LatLngBounds,n&&this._addChild(n),i&&this._addChild(i)},getAllChildMarkers:function(e){e=e||[];for(var t=this._childClusters.length-1;t>=0;t--)this._childClusters[t].getAllChildMarkers(e);for(var n=this._markers.length-1;n>=0;n--)e.push(this._markers[n]);return e},getChildCount:function(){return this._childCount},zoomToBounds:function(e){for(var t,n=this._childClusters.slice(),i=this._group._map,s=i.getBoundsZoom(this._bounds),o=this._zoom+1,l=i.getZoom();n.length>0&&s>o;){o++;var r=[];for(t=0;t<n.length;t++)r=r.concat(n[t]._childClusters);n=r}s>o?this._group._map.setView(this._latlng,o):l>=s?this._group._map.setView(this._latlng,l+1):this._group._map.fitBounds(this._bounds,e)},getBounds:function(){var e=new L.LatLngBounds;return e.extend(this._bounds),e},_updateIcon:function(){this._iconNeedsUpdate=!0,this._icon&&this.setIcon(this)},createIcon:function(){return this._iconNeedsUpdate&&(this._iconObj=this._group.options.iconCreateFunction(this),this._iconNeedsUpdate=!1),this._iconObj.createIcon()},createShadow:function(){return this._iconObj.createShadow()},_addChild:function(e,t){this._iconNeedsUpdate=!0,this._boundsNeedUpdate=!0,this._setClusterCenter(e),e instanceof L.MarkerCluster?(t||(this._childClusters.push(e),e.__parent=this),this._childCount+=e._childCount):(t||this._markers.push(e),this._childCount++),this.__parent&&this.__parent._addChild(e,!0)},_setClusterCenter:function(e){this._cLatLng||(this._cLatLng=e._cLatLng||e._latlng)},_resetBounds:function(){var e=this._bounds;e._southWest&&(e._southWest.lat=1/0,e._southWest.lng=1/0),e._northEast&&(e._northEast.lat=-1/0,e._northEast.lng=-1/0)},_recalculateBounds:function(){var e,t,n,i,s=this._markers,o=this._childClusters,l=0,r=0,a=this._childCount;if(0!==a){for(this._resetBounds(),e=0;e<s.length;e++)n=s[e]._latlng,this._bounds.extend(n),l+=n.lat,r+=n.lng;for(e=0;e<o.length;e++)(t=o[e])._boundsNeedUpdate&&t._recalculateBounds(),this._bounds.extend(t._bounds),n=t._wLatLng,i=t._childCount,l+=n.lat*i,r+=n.lng*i;this._latlng=this._wLatLng=new L.LatLng(l/a,r/a),this._boundsNeedUpdate=!1}},_addToMap:function(e){e&&(this._backupLatlng=this._latlng,this.setLatLng(e)),this._group._featureGroup.addLayer(this)},_recursivelyAnimateChildrenIn:function(e,t,n){this._recursively(e,this._group._map.getMinZoom(),n-1,function(e){var n,i,s=e._markers;for(n=s.length-1;n>=0;n--)(i=s[n])._icon&&(i._setPos(t),i.clusterHide())},function(e){var n,i,s=e._childClusters;for(n=s.length-1;n>=0;n--)(i=s[n])._icon&&(i._setPos(t),i.clusterHide())})},_recursivelyAnimateChildrenInAndAddSelfToMap:function(e,t,n,i){this._recursively(e,i,t,function(s){s._recursivelyAnimateChildrenIn(e,s._group._map.latLngToLayerPoint(s.getLatLng()).round(),n),s._isSingleParent()&&n-1===i?(s.clusterShow(),s._recursivelyRemoveChildrenFromMap(e,t,n)):s.clusterHide(),s._addToMap()})},_recursivelyBecomeVisible:function(e,t){this._recursively(e,this._group._map.getMinZoom(),t,null,function(e){e.clusterShow()})},_recursivelyAddChildrenToMap:function(e,t,n){this._recursively(n,this._group._map.getMinZoom()-1,t,function(i){if(t!==i._zoom)for(var s=i._markers.length-1;s>=0;s--){var o=i._markers[s];n.contains(o._latlng)&&(e&&(o._backupLatlng=o.getLatLng(),o.setLatLng(e),o.clusterHide&&o.clusterHide()),i._group._featureGroup.addLayer(o))}},function(t){t._addToMap(e)})},_recursivelyRestoreChildPositions:function(e){for(var t=this._markers.length-1;t>=0;t--){var n=this._markers[t];n._backupLatlng&&(n.setLatLng(n._backupLatlng),delete n._backupLatlng)}if(e-1===this._zoom)for(var i=this._childClusters.length-1;i>=0;i--)this._childClusters[i]._restorePosition();else for(var s=this._childClusters.length-1;s>=0;s--)this._childClusters[s]._recursivelyRestoreChildPositions(e)},_restorePosition:function(){this._backupLatlng&&(this.setLatLng(this._backupLatlng),delete this._backupLatlng)},_recursivelyRemoveChildrenFromMap:function(e,t,n,i){var s,o;this._recursively(e,t-1,n-1,function(e){for(o=e._markers.length-1;o>=0;o--)s=e._markers[o],i&&i.contains(s._latlng)||(e._group._featureGroup.removeLayer(s),s.clusterShow&&s.clusterShow())},function(e){for(o=e._childClusters.length-1;o>=0;o--)s=e._childClusters[o],i&&i.contains(s._latlng)||(e._group._featureGroup.removeLayer(s),s.clusterShow&&s.clusterShow())})},_recursively:function(e,t,n,i,s){var o,l,r=this._childClusters,a=this._zoom;if(a>=t&&(i&&i(this),s&&a===n&&s(this)),t>a||n>a)for(o=r.length-1;o>=0;o--)l=r[o],e.intersects(l._bounds)&&l._recursively(e,t,n,i,s)},_isSingleParent:function(){return this._childClusters.length>0&&this._childClusters[0]._childCount===this._childCount}}),L.Marker.include({clusterHide:function(){return this.options.opacityWhenUnclustered=this.options.opacity||1,this.setOpacity(0)},clusterShow:function(){var e=this.setOpacity(this.options.opacity||this.options.opacityWhenUnclustered);return delete this.options.opacityWhenUnclustered,e}}),L.DistanceGrid=function(e){this._cellSize=e,this._sqCellSize=e*e,this._grid={},this._objectPoint={}},L.DistanceGrid.prototype={addObject:function(e,t){var n=this._getCoord(t.x),i=this._getCoord(t.y),s=this._grid,o=s[i]=s[i]||{},l=o[n]=o[n]||[],r=L.Util.stamp(e);this._objectPoint[r]=t,l.push(e)},updateObject:function(e,t){this.removeObject(e),this.addObject(e,t)},removeObject:function(e,t){var n,i,s=this._getCoord(t.x),o=this._getCoord(t.y),l=this._grid,r=l[o]=l[o]||{},a=r[s]=r[s]||[];for(delete this._objectPoint[L.Util.stamp(e)],n=0,i=a.length;i>n;n++)if(a[n]===e)return a.splice(n,1),1===i&&delete r[s],!0},eachObject:function(e,t){var n,i,s,o,l,r,a=this._grid;for(n in a){l=a[n];for(i in l)for(r=l[i],s=0,o=r.length;o>s;s++)e.call(t,r[s])&&(s--,o--)}},getNearObject:function(e){var t,n,i,s,o,l,r,a,u=this._getCoord(e.x),c=this._getCoord(e.y),d=this._objectPoint,h=this._sqCellSize,p=null;for(t=c-1;c+1>=t;t++)if(s=this._grid[t])for(n=u-1;u+1>=n;n++)if(o=s[n])for(i=0,l=o.length;l>i;i++)r=o[i],a=this._sqDist(d[L.Util.stamp(r)],e),h>a&&(h=a,p=r);return p},_getCoord:function(e){return Math.floor(e/this._cellSize)},_sqDist:function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i}},L.QuickHull={getDistant:function(e,t){return(t[0].lng-t[1].lng)*(e.lat-t[0].lat)+(t[1].lat-t[0].lat)*(e.lng-t[0].lng)},findMostDistantPointFromBaseLine:function(e,t){var n,i,s,o=0,l=null,r=[];for(n=t.length-1;n>=0;n--)i=t[n],(s=this.getDistant(i,e))>0&&(r.push(i),s>o&&(o=s,l=i));return{maxPoint:l,newPoints:r}},buildConvexHull:function(e,t){var n=[],i=this.findMostDistantPointFromBaseLine(e,t);return i.maxPoint?(n=n.concat(this.buildConvexHull([e[0],i.maxPoint],i.newPoints)),n=n.concat(this.buildConvexHull([i.maxPoint,e[1]],i.newPoints))):[e[0]]},getConvexHull:function(e){var t,n=!1,i=!1,s=!1,o=!1,l=null,r=null,a=null,u=null,c=null,d=null;for(t=e.length-1;t>=0;t--){var h=e[t];(!1===n||h.lat>n)&&(l=h,n=h.lat),(!1===i||h.lat<i)&&(r=h,i=h.lat),(!1===s||h.lng>s)&&(a=h,s=h.lng),(!1===o||h.lng<o)&&(u=h,o=h.lng)}i!==n?(d=r,c=l):(d=u,c=a);return[].concat(this.buildConvexHull([d,c],e),this.buildConvexHull([c,d],e))}},L.MarkerCluster.include({getConvexHull:function(){var e,t,n=this.getAllChildMarkers(),i=[];for(t=n.length-1;t>=0;t--)e=n[t].getLatLng(),i.push(e);return L.QuickHull.getConvexHull(i)}}),L.MarkerCluster.include({_2PI:2*Math.PI,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_circleSpiralSwitchover:9,spiderfy:function(){if(this._group._spiderfied!==this&&!this._group._inZoomAnimation){var e,t=this.getAllChildMarkers(),n=this._group._map.latLngToLayerPoint(this._latlng);this._group._unspiderfy(),this._group._spiderfied=this,t.length>=this._circleSpiralSwitchover?e=this._generatePointsSpiral(t.length,n):(n.y+=10,e=this._generatePointsCircle(t.length,n)),this._animationSpiderfy(t,e)}},unspiderfy:function(e){this._group._inZoomAnimation||(this._animationUnspiderfy(e),this._group._spiderfied=null)},_generatePointsCircle:function(e,t){var n,i,s=this._group.options.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+e)/this._2PI,o=this._2PI/e,l=[];for(l.length=e,n=e-1;n>=0;n--)i=this._circleStartAngle+n*o,l[n]=new L.Point(t.x+s*Math.cos(i),t.y+s*Math.sin(i))._round();return l},_generatePointsSpiral:function(e,t){var n,i=this._group.options.spiderfyDistanceMultiplier,s=i*this._spiralLengthStart,o=i*this._spiralFootSeparation,l=i*this._spiralLengthFactor*this._2PI,r=0,a=[];for(a.length=e,n=e-1;n>=0;n--)r+=o/s+5e-4*n,a[n]=new L.Point(t.x+s*Math.cos(r),t.y+s*Math.sin(r))._round(),s+=l/r;return a},_noanimationUnspiderfy:function(){var e,t,n=this._group,i=n._map,s=n._featureGroup,o=this.getAllChildMarkers();for(n._ignoreMove=!0,this.setOpacity(1),t=o.length-1;t>=0;t--)e=o[t],s.removeLayer(e),e._preSpiderfyLatlng&&(e.setLatLng(e._preSpiderfyLatlng),delete e._preSpiderfyLatlng),e.setZIndexOffset&&e.setZIndexOffset(0),e._spiderLeg&&(i.removeLayer(e._spiderLeg),delete e._spiderLeg);n.fire("unspiderfied",{cluster:this,markers:o}),n._ignoreMove=!1,n._spiderfied=null}}),L.MarkerClusterNonAnimated=L.MarkerCluster.extend({_animationSpiderfy:function(e,t){var n,i,s,o,l=this._group,r=l._map,a=l._featureGroup,u=this._group.options.spiderLegPolylineOptions;for(l._ignoreMove=!0,n=0;n<e.length;n++)o=r.layerPointToLatLng(t[n]),i=e[n],s=new L.Polyline([this._latlng,o],u),r.addLayer(s),i._spiderLeg=s,i._preSpiderfyLatlng=i._latlng,i.setLatLng(o),i.setZIndexOffset&&i.setZIndexOffset(1e6),a.addLayer(i);this.setOpacity(.3),l._ignoreMove=!1,l.fire("spiderfied",{cluster:this,markers:e})},_animationUnspiderfy:function(){this._noanimationUnspiderfy()}}),L.MarkerCluster.include({_animationSpiderfy:function(e,t){var n,i,s,o,l,r,a=this,u=this._group,c=u._map,d=u._featureGroup,h=this._latlng,p=c.latLngToLayerPoint(h),f=L.Path.SVG,_=L.extend({},this._group.options.spiderLegPolylineOptions),m=_.opacity;for(void 0===m&&(m=L.MarkerClusterGroup.prototype.options.spiderLegPolylineOptions.opacity),f?(_.opacity=0,_.className=(_.className||"")+" leaflet-cluster-spider-leg"):_.opacity=m,u._ignoreMove=!0,n=0;n<e.length;n++)i=e[n],r=c.layerPointToLatLng(t[n]),s=new L.Polyline([h,r],_),c.addLayer(s),i._spiderLeg=s,f&&(o=s._path,l=o.getTotalLength()+.1,o.style.strokeDasharray=l,o.style.strokeDashoffset=l),i.setZIndexOffset&&i.setZIndexOffset(1e6),i.clusterHide&&i.clusterHide(),d.addLayer(i),i._setPos&&i._setPos(p);for(u._forceLayout(),u._animationStart(),n=e.length-1;n>=0;n--)r=c.layerPointToLatLng(t[n]),i=e[n],i._preSpiderfyLatlng=i._latlng,i.setLatLng(r),i.clusterShow&&i.clusterShow(),f&&(s=i._spiderLeg,o=s._path,o.style.strokeDashoffset=0,s.setStyle({opacity:m}));this.setOpacity(.3),u._ignoreMove=!1,setTimeout(function(){u._animationEnd(),u.fire("spiderfied",{cluster:a,markers:e})},200)},_animationUnspiderfy:function(e){var t,n,i,s,o,l,r=this,a=this._group,u=a._map,c=a._featureGroup,d=e?u._latLngToNewLayerPoint(this._latlng,e.zoom,e.center):u.latLngToLayerPoint(this._latlng),h=this.getAllChildMarkers(),p=L.Path.SVG;for(a._ignoreMove=!0,a._animationStart(),this.setOpacity(1),n=h.length-1;n>=0;n--)(t=h[n])._preSpiderfyLatlng&&(t.closePopup(),t.setLatLng(t._preSpiderfyLatlng),delete t._preSpiderfyLatlng,l=!0,t._setPos&&(t._setPos(d),l=!1),t.clusterHide&&(t.clusterHide(),l=!1),l&&c.removeLayer(t),p&&(i=t._spiderLeg,s=i._path,o=s.getTotalLength()+.1,s.style.strokeDashoffset=o,i.setStyle({opacity:0})));a._ignoreMove=!1,setTimeout(function(){var e=0;for(n=h.length-1;n>=0;n--)(t=h[n])._spiderLeg&&e++;for(n=h.length-1;n>=0;n--)(t=h[n])._spiderLeg&&(t.clusterShow&&t.clusterShow(),t.setZIndexOffset&&t.setZIndexOffset(0),e>1&&c.removeLayer(t),u.removeLayer(t._spiderLeg),delete t._spiderLeg);a._animationEnd(),a.fire("unspiderfied",{cluster:r,markers:h})},200)}}),L.MarkerClusterGroup.include({_spiderfied:null,unspiderfy:function(){this._unspiderfy.apply(this,arguments)},_spiderfierOnAdd:function(){this._map.on("click",this._unspiderfyWrapper,this),this._map.options.zoomAnimation&&this._map.on("zoomstart",this._unspiderfyZoomStart,this),this._map.on("zoomend",this._noanimationUnspiderfy,this),L.Browser.touch||this._map.getRenderer(this)},_spiderfierOnRemove:function(){this._map.off("click",this._unspiderfyWrapper,this),this._map.off("zoomstart",this._unspiderfyZoomStart,this),this._map.off("zoomanim",this._unspiderfyZoomAnim,this),this._map.off("zoomend",this._noanimationUnspiderfy,this),this._noanimationUnspiderfy()},_unspiderfyZoomStart:function(){this._map&&this._map.on("zoomanim",this._unspiderfyZoomAnim,this)},_unspiderfyZoomAnim:function(e){L.DomUtil.hasClass(this._map._mapPane,"leaflet-touching")||(this._map.off("zoomanim",this._unspiderfyZoomAnim,this),this._unspiderfy(e))},_unspiderfyWrapper:function(){this._unspiderfy()},_unspiderfy:function(e){this._spiderfied&&this._spiderfied.unspiderfy(e)},_noanimationUnspiderfy:function(){this._spiderfied&&this._spiderfied._noanimationUnspiderfy()},_unspiderfyLayer:function(e){e._spiderLeg&&(this._featureGroup.removeLayer(e),e.clusterShow&&e.clusterShow(),e.setZIndexOffset&&e.setZIndexOffset(0),this._map.removeLayer(e._spiderLeg),delete e._spiderLeg)}}),L.MarkerClusterGroup.include({refreshClusters:function(e){return e?e instanceof L.MarkerClusterGroup?e=e._topClusterLevel.getAllChildMarkers():e instanceof L.LayerGroup?e=e._layers:e instanceof L.MarkerCluster?e=e.getAllChildMarkers():e instanceof L.Marker&&(e=[e]):e=this._topClusterLevel.getAllChildMarkers(),this._flagParentsIconsNeedUpdate(e),this._refreshClustersIcons(),this.options.singleMarkerMode&&this._refreshSingleMarkerModeMarkers(e),this},_flagParentsIconsNeedUpdate:function(e){var t,n;for(t in e)for(n=e[t].__parent;n;)n._iconNeedsUpdate=!0,n=n.__parent},_refreshSingleMarkerModeMarkers:function(e){var t,n;for(t in e)n=e[t],this.hasLayer(n)&&n.setIcon(this._overrideMarkerIcon(n))}}),L.Marker.include({refreshIconOptions:function(e,t){var n=this.options.icon;return L.setOptions(n,e),this.setIcon(n),t&&this.__parent&&this.__parent._group.refreshClusters(this),this}})}(window,document)},938:function(e,t,n){"use strict";var i,s,o;!function(l){s=[n(939),n(940)],void 0===(o="function"==typeof(i=l)?i.apply(t,s):i)||(e.exports=o)}(function(e,t){})},939:function(e,t,n){"use strict";var i,s,o;!function(l,r){s=[n(138)],void 0===(o="function"==typeof(i=l)?i.apply(t,s):i)||(e.exports=o)}(function(e){e.TileLayer.Offline=e.TileLayer.extend({initialize:function(t,n,i){this._url=t,this._tilesDb=n,(i=e.Util.setOptions(this,i)).detectRetina&&e.Browser.retina&&i.maxZoom>0&&(i.tileSize=Math.floor(i.tileSize/2),i.zoomReverse?(i.zoomOffset--,i.minZoom++):(i.zoomOffset++,i.maxZoom--),i.minZoom=Math.max(0,i.minZoom)),"string"==typeof i.subdomains&&(i.subdomains=i.subdomains.split("")),e.Browser.android||this.on("tileunload",this._onTileRemove)},createTile:function(t,n){var i=document.createElement("img");return e.DomEvent.on(i,"load",e.bind(this._tileOnLoad,this,n,i)),e.DomEvent.on(i,"error",e.bind(this._tileOnError,this,n,i)),this.options.crossOrigin&&(i.crossOrigin=""),i.alt="",i.setAttribute("role","presentation"),this.getTileUrl(t).then(function(e){i.src=e}).catch(function(e){throw e}),i},getTileUrl:function(t){var n=e.TileLayer.prototype.getTileUrl.call(this,t),i=this._getStorageKey(n);return this._tilesDb.getItem(i).then(function(e){return e&&"object"==typeof e?URL.createObjectURL(e):n}).catch(function(e){throw e})},getTileUrls:function(t,n){var i=[],s=this._url;this.setUrl(this._url.replace("{z}",n),!0);for(var o=e.bounds(t.min.divideBy(this.getTileSize().x).floor(),t.max.divideBy(this.getTileSize().x).floor()),l=o.min.x;l<=o.max.x;l++)for(var r=o.min.y;r<=o.max.y;r++){var a=new e.Point(l,r),u=e.TileLayer.prototype.getTileUrl.call(this,a);i.push({key:this._getStorageKey(u),url:u})}return this.setUrl(s,!0),i},_getStorageKey:function(e){var t=null;if(e.indexOf("{s}")){var n=new RegExp("["+this.options.subdomains.join("|")+"].");t=e.replace(n,this.options.subdomains[0]+".")}return t||e}}),e.tileLayer.offline=function(t,n,i){return new e.TileLayer.Offline(t,n,i)}},window)},940:function(e,t,n){"use strict";var i,s,o;!function(l,r){s=[n(138)],void 0===(o="function"==typeof(i=l)?i.apply(t,s):i)||(e.exports=o)}(function(e){e.Control.Offline=e.Control.extend({options:{position:"topleft",saveButtonHtml:"S",saveButtonTitle:"Save tiles",removeButtonHtml:"R",removeButtonTitle:"Remove tiles",minZoom:0,maxZoom:19,confirmSavingCallback:null,confirmRemovalCallback:null},initialize:function(t,n,i){this._baseLayer=t,this._tilesDb=n,e.Util.setOptions(this,i)},onAdd:function(t){var n=e.DomUtil.create("div","leaflet-control-offline leaflet-bar");return this._createButton(this.options.saveButtonHtml,this.options.saveButtonTitle,"save-tiles-button",n,this._saveTiles),this._createButton(this.options.removeButtonHtml,this.options.removeButtonTitle,"remove-tiles-button",n,this._removeTiles),n},_createButton:function(t,n,i,s,o){var l=e.DomUtil.create("a",i,s);return l.innerHTML=t,l.href="#",l.title=n,e.DomEvent.disableClickPropagation(l),e.DomEvent.on(l,"click",e.DomEvent.stop),e.DomEvent.on(l,"click",o,this),e.DomEvent.on(l,"click",this._refocusOnMap,this),l},_saveTiles:function(){var t=this,n=null,i=[],s=[],o=this._map.getZoom(),l=this._map.getBounds();if(o<this.options.minZoom)t._baseLayer.fire("offline:below-min-zoom-error");else{for(var r=o;r<=this.options.maxZoom;r++)i.push(r);for(var a=0;a<i.length;a++)n=e.bounds(this._map.project(l.getNorthWest(),i[a]),this._map.project(l.getSouthEast(),i[a])),s=s.concat(this._baseLayer.getTileUrls(n,i[a]));var u=function(){t._baseLayer.fire("offline:save-start",{nTilesToSave:s.length}),t._tilesDb.saveTiles(s).then(function(){t._baseLayer.fire("offline:save-end")}).catch(function(e){t._baseLayer.fire("offline:save-error",{error:e})})};this.options.confirmSavingCallback?this.options.confirmSavingCallback(s.length,u):u()}},_removeTiles:function(){var e=this,t=function(){e._baseLayer.fire("offline:remove-start"),e._tilesDb.clear().then(function(){e._baseLayer.fire("offline:remove-end")}).catch(function(t){e._baseLayer.fire("offline:remove-error",{error:t})})};e.options.confirmRemovalCallback?e.options.confirmRemovalCallback(t):t()}}),e.control.offline=function(t,n,i){return new e.Control.Offline(t,n,i)}},window)},941:function(e,t){!function(){var e=L.Marker.prototype._initIcon,t=L.Marker.prototype._setPos,n="msTransform"===L.DomUtil.TRANSFORM;L.Marker.addInitHook(function(){var e=this.options.icon&&this.options.icon.options&&this.options.icon.options.iconAnchor;e&&(e=e[0]+"px "+e[1]+"px"),this.options.rotationOrigin=this.options.rotationOrigin||e||"center bottom",this.options.rotationAngle=this.options.rotationAngle||0,this.on("drag",function(e){e.target._applyRotation()})}),L.Marker.include({_initIcon:function(){e.call(this)},_setPos:function(e){t.call(this,e),this._applyRotation()},_applyRotation:function(){this.options.rotationAngle&&(this._icon.style[L.DomUtil.TRANSFORM+"Origin"]=this.options.rotationOrigin,n?this._icon.style[L.DomUtil.TRANSFORM]="rotate("+this.options.rotationAngle+"deg)":this._icon.style[L.DomUtil.TRANSFORM]+=" rotateZ("+this.options.rotationAngle+"deg)")},setRotationAngle:function(e){return this.options.rotationAngle=e,this.update(),this},setRotationOrigin:function(e){return this.options.rotationOrigin=e,this.update(),this}})}()},944:function(e,t){!function(){var e=Math.PI,t=2*e,n=e/180,i=document.createElement("div");document.head.appendChild(i);var s=self.ConicGradient=function(e){s.all.push(this),e=e||{},this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.repeating=!!e.repeating,this.size=e.size||Math.max(innerWidth,innerHeight),this.canvas.width=this.canvas.height=this.size;this.stops=((l=e.stops)||"").split(/\s*,(?![^(]*\))\s*/),this.from=0;for(var t=0;t<this.stops.length;t++)if(this.stops[t]){var n=this.stops[t]=new s.ColorStop(this,this.stops[t]);n.next&&(this.stops.splice(t+1,0,n.next),t++)}else this.stops.splice(t,1),t--;if(0==this.stops[0].color.indexOf("from")&&(this.from=360*this.stops[0].pos,this.stops.shift()),void 0===this.stops[0].pos)this.stops[0].pos=0;else if(this.stops[0].pos>0){var i=this.stops[0].clone();i.pos=0,this.stops.unshift(i)}if(void 0===this.stops[this.stops.length-1].pos)this.stops[this.stops.length-1].pos=1;else if(!this.repeating&&this.stops[this.stops.length-1].pos<1){var o=this.stops[this.stops.length-1].clone();o.pos=1,this.stops.push(o)}if(this.stops.forEach(function(e,t){if(void 0===e.pos){for(var n=t+1;this[n];n++)if(void 0!==this[n].pos){e.pos=this[t-1].pos+(this[n].pos-this[t-1].pos)/(n-t+1);break}}else t>0&&(e.pos=Math.max(e.pos,this[t-1].pos))},this.stops),this.repeating){var l,r=(l=this.stops.slice())[l.length-1].pos-l[0].pos;for(t=0;this.stops[this.stops.length-1].pos<1&&t<1e4;t++)for(var a=0;a<l.length;a++){var u=l[a].clone();u.pos+=(t+1)*r,this.stops.push(u)}}this.paint()};s.all=[],s.prototype={toString:function(){return"url('"+this.dataURL+"')"},get dataURL(){return"data:image/svg+xml,"+encodeURIComponent(this.svg)},get blobURL(){return URL.createObjectURL(new Blob([this.svg],{type:"image/svg+xml"}))},get svg(){return'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="none"><svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice"><image width="100" height="100%" xlink:href="'+this.png+'" /></svg></svg>'},get png(){return this.canvas.toDataURL()},get r(){return Math.sqrt(2)*this.size/2},paint:function(){var e,t,i,s=this.context,o=this.r,l=this.size/2,r=0,a=this.stops[r];s.translate(this.size/2,this.size/2),s.rotate(-90*n),s.rotate(this.from*n),s.translate(-this.size/2,-this.size/2);for(var u=0;u<360;){if(u/360+1e-5>=a.pos){do{e=a,a=this.stops[++r]}while(a&&a!=e&&a.pos===e.pos);if(!a)break;var c=e.color+""==a.color+""&&e!=a;t=e.color.map(function(e,t){return a.color[t]-e})}i=(u/360-e.pos)/(a.pos-e.pos);var d=c?a.color:t.map(function(t,n){var s=t*i+e.color[n];return n<3?255&s:s});if(s.fillStyle="rgba("+d.join(",")+")",s.beginPath(),s.moveTo(l,l),c)var h=360*(a.pos-e.pos);else h=.5;var p=u*n,f=(p=Math.min(360*n,p))+h*n;f=Math.min(360*n,f+.02),s.arc(l,l,o,p,f),s.closePath(),s.fill(),u+=h}}},s.ColorStop=function(e,n){if(this.gradient=e,n){var i=n.match(/^(.+?)(?:\s+([\d.]+)(%|deg|turn|grad|rad)?)?(?:\s+([\d.]+)(%|deg|turn|grad|rad)?)?\s*$/);if(this.color=s.ColorStop.colorToRGBA(i[1]),i[2]){var o=i[3];"%"==o||"0"===i[2]&&!o?this.pos=i[2]/100:"turn"==o?this.pos=+i[2]:"deg"==o?this.pos=i[2]/360:"grad"==o?this.pos=i[2]/400:"rad"==o&&(this.pos=i[2]/t)}i[4]&&(this.next=new s.ColorStop(e,i[1]+" "+i[4]+i[5]))}},s.ColorStop.prototype={clone:function(){var e=new s.ColorStop(this.gradient);return e.color=this.color,e.pos=this.pos,e},toString:function(){return"rgba("+this.color.join(", ")+") "+100*this.pos+"%"}},s.ColorStop.colorToRGBA=function(e){if(!Array.isArray(e)&&-1==e.indexOf("from")){i.style.color=e;var t=getComputedStyle(i).color.match(/rgba?\(([\d.]+), ([\d.]+), ([\d.]+)(?:, ([\d.]+))?\)/);return t&&(t.shift(),(t=t.map(function(e){return+e}))[3]=isNaN(t[3])?1:t[3]),t||[0,0,0,0]}return e}}(),self.StyleFix&&function(){var e=document.createElement("p");e.style.backgroundImage="conic-gradient(white, black)",e.style.backgroundImage=PrefixFree.prefix+"conic-gradient(white, black)",e.style.backgroundImage||StyleFix.register(function(e,t){return e.indexOf("conic-gradient")>-1&&(e=e.replace(/(?:repeating-)?conic-gradient\(\s*((?:\([^()]+\)|[^;()}])+?)\)/g,function(e,t){return new ConicGradient({stops:t,repeating:e.indexOf("repeating-")>-1})})),e})}()}});